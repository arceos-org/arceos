{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Starry \u8bbe\u8ba1\u6587\u6863","text":"<p>\u9648\u5609\u94b0\u3001\u90d1\u53cb\u6377\u3001\u738b\u6631\u680b</p> <p>Starry\u662f\u4e00\u4e2a\u53ef\u4ee5\u5728<code>qemu</code>\u4e0a\u8fd0\u884c\u7684\u591a\u6838\u6a21\u5757\u5316OS\uff08\u5bf9\u4e8e<code>sifive-fu740</code>\u7684\u652f\u6301\u8fd8\u5728\u5de5\u4f5c\u4e2d\uff09</p>"},{"location":"1.%E6%A6%82%E8%BF%B0/1.1%E8%83%8C%E6%99%AF/","title":"1.\u6982\u8ff0","text":""},{"location":"1.%E6%A6%82%E8%BF%B0/1.1%E8%83%8C%E6%99%AF/#_1","title":"\u80cc\u666f","text":"<p>Starry\u662f\u5728<code>ArceOs</code>rcore-os/arceos: An experimental modular OS written in Rust.\u57fa\u7840\u4e0a\u8fdb\u884c\u5f00\u53d1\u7684\u3001\u4ee5\u5b8f\u5185\u6838\u67b6\u6784\u8fd0\u884cLinux\u5e94\u7528\u7684\u5185\u6838\u3002\u539f\u6709\u7684ArceOS\u8bbe\u8ba1\u67b6\u6784\u4e3a<code>Unikernel</code>\uff0c\u540e\u7eed\u8ba1\u5212\u5728\u539f\u6709\u4ee3\u7801\u7ed3\u6784\u7684\u57fa\u7840\u4e0a\u8bbe\u8ba1\u5b8f\u5185\u6838\u67b6\u6784\u548c\u5fae\u5185\u6838\u67b6\u6784\uff0c\u800cStarry\u5373\u662fArceOS\u5b8f\u5185\u6838\u67b6\u6784\u5316\u7684\u4e00\u4e2a\u6210\u679c\u3002</p>"},{"location":"1.%E6%A6%82%E8%BF%B0/1.1%E8%83%8C%E6%99%AF/#_2","title":"\u76ee\u524d\u6d4b\u4f8b\u652f\u6301","text":"<p>\u5f53\u524d\u6d4b\u4f8b\u652f\u6301\u5982\u4e0b\uff1a</p> <ul> <li>musl-libc\uff1a\u9759\u6001\u94fe\u63a5\u4e0e\u52a8\u6001\u94fe\u63a5\u5747\u5df2\u652f\u6301\uff0c\u5b9e\u73b0\u7684\u7279\u6027\u6709\u52a8\u6001\u5e93\u52a0\u8f7d\u3001\u7ebf\u7a0b\u3001\u4fe1\u53f7\u3001futex\u7b49</li> <li>lua\uff1a\u5df2\u7ecf\u652f\u6301</li> <li>busybox\uff1a\u5df2\u7ecf\u652f\u6301\u5927\u90e8\u5206\u6307\u4ee4\uff0c\u901a\u8fc7\u4e86\u6bd4\u8d5b\u7684\u6d4b\u4f8b</li> <li>lmbench\uff1a\u5df2\u7ecf\u652f\u6301\uff0c\u53ef\u4ee5\u4f7f\u7528lmbench\u6d4b\u7b97\u5185\u6838\u6027\u80fd</li> <li>iperf/netperf\uff1a\u652f\u6301\u5927\u90e8\u5206\u6d4b\u4f8b\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7f51\u7edc\u7684\u57fa\u672c\u529f\u80fd</li> <li>UnixBench\uff1a\u5df2\u7ecf\u652f\u6301\uff0c\u53ef\u4ee5\u7528\u6765\u6d4b\u7b97\u5185\u6838\u5728\u6587\u4ef6\u8bfb\u53d6\u3001\u6570\u636e\u57fa\u672c\u64cd\u4f5c\u7b49\u65b9\u9762\u7684\u6027\u80fd</li> <li>libc-bench\uff1a\u5df2\u7ecf\u652f\u6301</li> </ul>"},{"location":"1.%E6%A6%82%E8%BF%B0/1.1%E8%83%8C%E6%99%AF/#_3","title":"\u4f7f\u7528\u65b9\u5f0f","text":"<p>\u8be6\u89c1\u4e3b\u9875\u9762\u7684README.md</p> <p>\u76f8\u5173\u4f9d\u8d56\u5e93\u5747\u5df2\u672c\u5730\u5316\u5728<code>vendor</code>\u6587\u4ef6\u5939\u4e2d</p>"},{"location":"2.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/2.1ArceOS%E4%BB%8B%E7%BB%8D/","title":"2.1 ArceOS\u4ecb\u7ecd","text":""},{"location":"2.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/2.1ArceOS%E4%BB%8B%E7%BB%8D/#starry","title":"Starry\u7ed3\u6784\u8bf4\u660e","text":"<ul> <li>crates\uff1a\u4e0eOS\u8bbe\u8ba1\u65e0\u5173\u7684\u516c\u5171\u7ec4\u4ef6</li> <li>modules\uff1a\u4e0eOS\u8bbe\u8ba1\u66f4\u52a0\u8026\u5408\u7684\u7ec4\u4ef6\uff0c\u5404\u4e2a\u6a21\u5757\u529f\u80fd\u7b80\u8981\u4ecb\u7ecd\u5982\u4e0b\uff1a</li> <li>axalloc\uff1a\u5b9e\u73b0\u5168\u5c40\u5206\u914d\u5668</li> <li>axconfig\uff1a\u5b9a\u4e49\u5185\u6838\u53c2\u6570</li> <li>axdisplay\uff1a\u7b80\u5355\u7684\u56fe\u5f62\u5316\u5b9e\u73b0</li> <li>axdriver\uff1a\u8bbe\u5907\u9a71\u52a8\u7ba1\u7406</li> <li>axfs\uff1a\u6587\u4ef6\u7cfb\u7edf\u652f\u6301</li> <li>axhal\uff1a\u786c\u4ef6\u62bd\u8c61\u5c42\uff0c\u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u7684\u5e73\u53f0API\uff0c\u5982trap\u5165\u53e3\u7b49</li> <li>axlog\uff1alog\u8f93\u51fa\u5c42</li> <li>axnet\uff1a\u7f51\u7edc\u6a21\u5757</li> <li>axruntime\uff1a\u8fd0\u884c\u5e93\uff0c\u5b9a\u4e49\u4e86\u5185\u6838\u7684\u542f\u52a8\u903b\u8f91</li> <li>axsync\uff1a\u5b9e\u73b0\u540c\u6b65\u6a21\u5757</li> <li>axmem\uff1a\u5730\u5740\u7a7a\u95f4\u6a21\u5757</li> <li>axprocess\uff1a\u8fdb\u7a0b\u6a21\u5757\uff0c\u4e5f\u5b9e\u73b0\u4e86\u52a8\u6001\u52a0\u8f7d</li> <li>axsignal\uff1a\u4fe1\u53f7\u6a21\u5757</li> <li> <p>axtask\uff1a\u5b9a\u4e49\u4e86\u4efb\u52a1\u4e0e\u8c03\u5ea6\u5e8f\u5217\u7684\u64cd\u4f5c</p> </li> <li> <p>apps\uff1aunikernel\u67b6\u6784\u4e0b\u7684\u7528\u6237\u7a0b\u5e8f\uff0c\u7ee7\u627f\u539f\u6709ArceOS</p> </li> <li> <p>ulib\uff1a\u7528\u6237\u5e93\uff0c\u7ee7\u627f\u539f\u6709ArceOS\uff0c\u5e76\u6dfb\u52a0\u4e86starry_libax\u90e8\u5206\u4f5c\u4e3aLinux\u517c\u5bb9\u5c42\u3002</p> </li> <li> <p>\u4e3a\u4e86\u5b9e\u73b0\u5b8f\u5185\u6838\u67b6\u6784\u4f53\u7cfb\uff0c\u9700\u8981\u5bf9\u539f\u6709Arceos\u7684\u90e8\u5206\u6838\u5fc3\u6a21\u5757\uff08\u5982axtask\uff09\u8fdb\u884c\u4fee\u6539\u3002\u4e3a\u4e86\u9632\u6b62\u5408\u5e76\u65f6\u51b2\u7a81\u8fc7\u591a\uff0c\u56e0\u6b64\u5728\u5bf9\u5e94\u6a21\u5757\u4e0b\u5efa\u7acb<code>monolithic*</code>\u4e3a\u524d\u7f00\u7684\u6587\u4ef6\u5939\uff0c\u5b58\u653e\u4e3a\u5b8f\u5185\u6838\u67b6\u6784\u5b9e\u73b0\u7684\u5185\u5bb9\u3002\u540c\u65f6\u4f7f\u7528\u6761\u4ef6\u7f16\u8bd1\u6765\u9009\u62e9\u662f\u5b8f\u5185\u6838\u67b6\u6784\u8fd8\u662funikernel\u67b6\u6784\u3002</p> </li> <li> <p>\u4e3a\u4e86\u5b9e\u73b0linux APP\u517c\u5bb9\uff0c\u9700\u8981\u5b9e\u73b0\u4e00\u7cfb\u5217\u9762\u5411linux\u7684\u7cfb\u7edf\u8c03\u7528\u3002\u6211\u4eec\u5c06\u7cfb\u7edf\u8c03\u7528\u7684\u5177\u4f53\u5b9e\u73b0\u90e8\u5206\u653e\u5728<code>starry_libax</code>\u90e8\u5206\uff0c\u5373\u4ee5\u7528\u6237\u5e93\u7684\u5f62\u5f0f\u5f62\u6210\u4e00\u4e2alinux\u517c\u5bb9\u5c42\u3002\u901a\u8fc7\u8c03\u7528\u4e0a\u8ff0\u6a21\u5757\u63d0\u4f9b\u7684\u4e00\u7cfb\u5217\u63a5\u53e3\uff0c\u5b9e\u73b0\u5bf9\u5e94\u7684linux \u7cfb\u7edf\u8c03\u7528\uff0c\u5e76\u66b4\u9732\u7ed9\u5916\u754c\u3002\u8fd9\u4e2a\u7cfb\u7edf\u517c\u5bb9\u5c42\u4e0e\u539f\u6709\u7684<code>libax</code>\u8fdb\u884c\u5bf9\u5e94\uff0c\u5206\u522b\u63d0\u4f9b\u4e0d\u540c\u7684\u63a5\u53e3\u4e0e\u670d\u52a1\u3002</p> </li> <li> <p>\u6a21\u5757\u90e8\u5206\u653e\u7f6e\u53ef\u4ee5\u4e3a\u5b8f\u5185\u6838\u4e0eunikernel\u5c3d\u53ef\u80fd\u5171\u4eab\u7684\u5185\u5bb9\uff0c\u901a\u8fc7\u6761\u4ef6\u7f16\u8bd1\u7b49\u65b9\u5f0f\u505a\u5230\u5c3d\u53ef\u80fd\u5730\u4e3a\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u517c\u5bb9\u5c42\u6240\u8c03\u7528\u3002</p> </li> </ul>"},{"location":"2.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/2.2Starry%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E/","title":"2.2 Starry\u7ed3\u6784\u8bf4\u660e","text":""},{"location":"2.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/2.2Starry%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E/#starry","title":"Starry\u7ed3\u6784\u8bf4\u660e","text":"<ul> <li>crates\uff1a\u4e0eOS\u8bbe\u8ba1\u65e0\u5173\u7684\u516c\u5171\u7ec4\u4ef6</li> <li>modules\uff1a\u4e0eOS\u8bbe\u8ba1\u66f4\u52a0\u8026\u5408\u7684\u7ec4\u4ef6\uff0c\u5404\u4e2a\u6a21\u5757\u529f\u80fd\u7b80\u8981\u4ecb\u7ecd\u5982\u4e0b\uff1a</li> <li>axalloc\uff1a\u5b9e\u73b0\u5168\u5c40\u5206\u914d\u5668</li> <li>axconfig\uff1a\u5b9a\u4e49\u5185\u6838\u53c2\u6570</li> <li>axdisplay\uff1a\u7b80\u5355\u7684\u56fe\u5f62\u5316\u5b9e\u73b0</li> <li>axdriver\uff1a\u8bbe\u5907\u9a71\u52a8\u7ba1\u7406</li> <li>axfs\uff1a\u6587\u4ef6\u7cfb\u7edf\u652f\u6301</li> <li>axhal\uff1a\u786c\u4ef6\u62bd\u8c61\u5c42\uff0c\u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u7684\u5e73\u53f0API\uff0c\u5982trap\u5165\u53e3\u7b49</li> <li>axlog\uff1alog\u8f93\u51fa\u5c42</li> <li>axnet\uff1a\u7f51\u7edc\u6a21\u5757</li> <li>axruntime\uff1a\u8fd0\u884c\u5e93\uff0c\u5b9a\u4e49\u4e86\u5185\u6838\u7684\u542f\u52a8\u903b\u8f91</li> <li>axsync\uff1a\u5b9e\u73b0\u540c\u6b65\u6a21\u5757</li> <li>axmem\uff1a\u5730\u5740\u7a7a\u95f4\u6a21\u5757</li> <li>axprocess\uff1a\u8fdb\u7a0b\u6a21\u5757\uff0c\u4e5f\u5b9e\u73b0\u4e86\u52a8\u6001\u52a0\u8f7d</li> <li>axsignal\uff1a\u4fe1\u53f7\u6a21\u5757</li> <li> <p>axtask\uff1a\u5b9a\u4e49\u4e86\u4efb\u52a1\u4e0e\u8c03\u5ea6\u5e8f\u5217\u7684\u64cd\u4f5c</p> </li> <li> <p>apps\uff1aunikernel\u67b6\u6784\u4e0b\u7684\u7528\u6237\u7a0b\u5e8f\uff0c\u7ee7\u627f\u539f\u6709ArceOS</p> </li> <li> <p>ulib\uff1a\u7528\u6237\u5e93\uff0c\u7ee7\u627f\u539f\u6709ArceOS\uff0c\u5e76\u6dfb\u52a0\u4e86starry_libax\u90e8\u5206\u4f5c\u4e3aLinux\u517c\u5bb9\u5c42\u3002</p> </li> <li> <p>\u4e3a\u4e86\u5b9e\u73b0\u5b8f\u5185\u6838\u67b6\u6784\u4f53\u7cfb\uff0c\u9700\u8981\u5bf9\u539f\u6709Arceos\u7684\u90e8\u5206\u6838\u5fc3\u6a21\u5757\uff08\u5982axtask\uff09\u8fdb\u884c\u4fee\u6539\u3002\u4e3a\u4e86\u9632\u6b62\u5408\u5e76\u65f6\u51b2\u7a81\u8fc7\u591a\uff0c\u56e0\u6b64\u5728\u5bf9\u5e94\u6a21\u5757\u4e0b\u5efa\u7acb<code>monolithic*</code>\u4e3a\u524d\u7f00\u7684\u6587\u4ef6\u5939\uff0c\u5b58\u653e\u4e3a\u5b8f\u5185\u6838\u67b6\u6784\u5b9e\u73b0\u7684\u5185\u5bb9\u3002\u540c\u65f6\u4f7f\u7528\u6761\u4ef6\u7f16\u8bd1\u6765\u9009\u62e9\u662f\u5b8f\u5185\u6838\u67b6\u6784\u8fd8\u662funikernel\u67b6\u6784\u3002</p> </li> <li> <p>\u4e3a\u4e86\u5b9e\u73b0linux APP\u517c\u5bb9\uff0c\u9700\u8981\u5b9e\u73b0\u4e00\u7cfb\u5217\u9762\u5411linux\u7684\u7cfb\u7edf\u8c03\u7528\u3002\u6211\u4eec\u5c06\u7cfb\u7edf\u8c03\u7528\u7684\u5177\u4f53\u5b9e\u73b0\u90e8\u5206\u653e\u5728<code>starry_libax</code>\u90e8\u5206\uff0c\u5373\u4ee5\u7528\u6237\u5e93\u7684\u5f62\u5f0f\u5f62\u6210\u4e00\u4e2alinux\u517c\u5bb9\u5c42\u3002\u901a\u8fc7\u8c03\u7528\u4e0a\u8ff0\u6a21\u5757\u63d0\u4f9b\u7684\u4e00\u7cfb\u5217\u63a5\u53e3\uff0c\u5b9e\u73b0\u5bf9\u5e94\u7684linux \u7cfb\u7edf\u8c03\u7528\uff0c\u5e76\u66b4\u9732\u7ed9\u5916\u754c\u3002\u8fd9\u4e2a\u7cfb\u7edf\u517c\u5bb9\u5c42\u4e0e\u539f\u6709\u7684<code>libax</code>\u8fdb\u884c\u5bf9\u5e94\uff0c\u5206\u522b\u63d0\u4f9b\u4e0d\u540c\u7684\u63a5\u53e3\u4e0e\u670d\u52a1\u3002</p> </li> <li> <p>\u6a21\u5757\u90e8\u5206\u653e\u7f6e\u53ef\u4ee5\u4e3a\u5b8f\u5185\u6838\u4e0eunikernel\u5c3d\u53ef\u80fd\u5171\u4eab\u7684\u5185\u5bb9\uff0c\u901a\u8fc7\u6761\u4ef6\u7f16\u8bd1\u7b49\u65b9\u5f0f\u505a\u5230\u5c3d\u53ef\u80fd\u5730\u4e3a\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u517c\u5bb9\u5c42\u6240\u8c03\u7528\u3002</p> </li> </ul>"},{"location":"2.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/2.2Starry%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E/#_1","title":"\u7ed3\u6784\u56fe\u5bf9\u6bd4","text":"<p>\u539f\u5148Arceos\u7ed3\u6784\u56fe\uff1a</p> <p></p> <p>\u91cd\u6784\u540eStarryOS\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>Starry\u7684\u6a21\u5757\u4f9d\u8d56\u56fe\u5982\u4e0b\uff1a</p> <pre><code>graph TD;\naxsync--&gt;axdisplay\naxdriver--&gt;axdisplay\n\naxhal--&gt;axdriver\naxalloc--&gt;axdriver\naxconfig--&gt;axdriver\n\naxdriver--&gt;axfs\naxsync--&gt;axfs\naxtask-.dev.-&gt;axfs\n\naxconfig--&gt;axhal\naxalloc--&gt;axhal\naxlog--&gt;axhal\n\naxhal--&gt;axnet\naxsync--&gt;axnet\naxtask--&gt;axnet\naxdriver--&gt;axnet\n\naxalloc--&gt;axruntime\naxconfig--&gt;axruntime\naxdriver--&gt;axruntime\naxhal--&gt;axruntime\naxlog--&gt;axruntime\naxnet--&gt;axruntime\naxdisplay--&gt;axruntime\naxtask--&gt;axruntime\naxprocess--&gt;axruntime\naxtask--&gt;axsync\naxtask--&gt;axprocess\naxfs--&gt;axprocess\naxhal--&gt;axprocess\n\naxalloc--&gt;axtask\naxhal--&gt;axtask\naxconfig--&gt;axtask\naxlog--&gt;axtask\n\naxfs--&gt;axmem\naxalloc--&gt;axmem\naxhal--&gt;axmem\naxhal--&gt;axsignal\naxmem--&gt;axprocess\naxsignal--&gt;axprocess\n</code></pre>"},{"location":"2.%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/2.2Starry%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E/#_2","title":"\u7ed3\u6784\u4f18\u52bf","text":"<ol> <li>\u7528\u76f8\u540c\u7684\u4ee3\u7801\u7ec4\u4ef6\uff0c\u5229\u7528\u6761\u4ef6\u7f16\u8bd1\u7b49\u65b9\u5f0f\u53ef\u4ee5\u7ec4\u5efa\u51fa\u4e0d\u540c\u67b6\u6784\u7684OS\u5185\u6838\uff0c\u4ece\u800c\u53ef\u4ee5\u8fbe\u5230\u4f7f\u7528\u4e0d\u540c\u7684\u542f\u52a8\u53c2\u6570\u6765\u542f\u52a8\u4e0d\u540c\u67b6\u6784\u7684\u5185\u6838\uff0c\u5927\u5927\u63d0\u9ad8\u5185\u6838\u7684\u6cdb\u7528\u6027\u3002</li> <li>\u5728\u5229\u7528unikernel\u53ef\u63d2\u62d4\u7684\u7279\u6027\u7684\u57fa\u7840\u4e0a\uff0c\u53ef\u4ee5\u4f7f\u5f97\u5b9e\u73b0\u67d0\u4e00\u4e2a\u529f\u80fd\u7684crate\u548c\u6574\u4f53OS\u8fdb\u4e00\u6b65\u89e3\u8026\uff0c\u4ece\u800c\u5229\u4e8e\u66f4\u65b0\u6362\u4ee3\u3002</li> <li>\u89e3\u8026\u7684\u7279\u6027\u5229\u4e8e\u5f00\u53d1\u6a21\u5f0f\u7684\u5206\u5de5\uff0c\u4e0d\u540c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u8d1f\u8d23\u4e0d\u540c\u7684module\u6216\u8005crate\u5185\u5bb9\uff0c\u53ea\u8981\u5b9e\u73b0\u4e86\u5bf9\u5e94\u7684\u63a5\u53e3\u4fbf\u53ef\u4ee5\u8f83\u597d\u5730\u9002\u914d\u672c\u5185\u6838\uff0c\u4ece\u800c\u65b9\u4fbf\u5176\u4ed6\u5f00\u53d1\u4eba\u5458\u53c2\u4e0e\u5176\u4e2d\u4e0d\u65ad\u5b8c\u5584\u3002</li> </ol>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/","title":"3.1 \u6a21\u5757\u5212\u5206","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#_1","title":"\u8fdb\u7a0b\u5f15\u5165","text":"<p>\u4e3a\u4e86\u8fd0\u884cLinux\u76f8\u5173\u7684\u5e94\u7528\uff0c\u6211\u4eec\u9700\u8981\u8ba9\u4e0d\u540c\u4efb\u52a1\u4e4b\u95f4\u5b58\u5728\u7236\u5b50\u7b49\u5173\u7cfb\uff0c\u56e0\u6b64\u6211\u4eec\u5f15\u5165\u4e86\u8fdb\u7a0b\u7684\u6982\u5ff5\u3002\u5728\u6807\u51c6\u7684Linux\u4e2d\uff0c\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u7edf\u4e00\u7528pthread\u7ed3\u6784\u4f53\u4ee3\u66ff\uff0c\u4f46\u6211\u4eec\u4e3a\u4e86\u4fdd\u8bc1\u539f\u6709arceos\u7684\u4efb\u52a1\u8c03\u5ea6\u7ed3\u6784\u4e0d\u53d7\u8fc7\u5927\u5f71\u54cd\uff0c\u56e0\u6b64\u9009\u62e9\u5c06\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u8fdb\u884c\u5206\u79bb\uff0c\u8fdb\u7a0b\u4fdd\u5b58\u5728\u72ec\u7acb\u7684\u7ed3\u6784\u4f53<code>Process</code>\u4e2d\u3002</p> <p>\u4f9d\u636e\u6a21\u5757\u5316\u7684\u601d\u60f3\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8fdb\u7a0b\u89c6\u4e3a\u4e00\u4e2a\u5bb9\u5668\uff0c\u5b58\u50a8\u4e86\u5404\u7c7b\u8fd0\u884c\u65f6\u8d44\u6e90\uff0c\u5305\u62ec\u865a\u5b58\u3001\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u7ebf\u7a0b\u3001\u4fe1\u53f7\u7b49\u3002 \u5728\u8be5\u79cd\u8bbe\u8ba1\u7406\u5ff5\u4e0b\uff0c\u8fdb\u7a0b\u4ec5\u662f\u5bf9\u4e0a\u8ff0\u8d44\u6e90\u7684\u4e00\u4e2a\u7edf\u4e00\u4e0e\u5305\u88c5\u3002\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0 feature \u7b49\u65b9\u5f0f\u5c06\u8fdb\u7a0b\u4f5c\u4e3a\u4e00\u4e2a\u53ef\u63d2\u62d4\u6a21\u5757\uff0c\u4f7f\u5f97\u5185\u6838\u5728\u5b8f\u5185\u6838\u67b6\u6784\u4e0e\u5fae\u5185\u6838\u67b6\u6784\u4e2d\u968f\u65f6\u8fdb\u884c\u5207\u6362\u3002</p> <p>\u8fdb\u7a0b\u7ed3\u6784\u8bbe\u8ba1\u5982\u4e0b\uff1a</p> <pre><code>pub struct ProcessInner {\n/// \u7236\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7\npub parent: u64,\n/// \u5b50\u8fdb\u7a0b\npub children: Vec&lt;Arc&lt;Process&gt;&gt;,\n/// \u5b50\u4efb\u52a1\npub tasks: Vec&lt;AxTaskRef&gt;,\n/// \u5730\u5740\u7a7a\u95f4\uff0c\u7531\u4e8e\u5b58\u5728\u5730\u5740\u7a7a\u95f4\u5171\u4eab\uff0c\u56e0\u6b64\u8bbe\u8ba1\u4e3aArc\u7c7b\u578b\npub memory_set: Arc&lt;SpinNoIrq&lt;MemorySet&gt;&gt;,\n/// \u7528\u6237\u5806\u57fa\u5740\uff0c\u4efb\u4f55\u65f6\u5019\u5806\u9876\u90fd\u4e0d\u80fd\u6bd4\u8fd9\u4e2a\u503c\u5c0f\uff0c\u7406\u8bba\u4e0a\u8bb2\u662f\u4e00\u4e2a\u5e38\u91cf\npub heap_bottom: usize,\n/// \u5f53\u524d\u7528\u6237\u5806\u7684\u5806\u9876\uff0c\u4e0d\u80fd\u5c0f\u4e8e\u57fa\u5740\uff0c\u4e0d\u80fd\u5927\u4e8e\u57fa\u5740\u52a0\u5806\u7684\u6700\u5927\u5927\u5c0f\npub heap_top: usize,\n/// \u8fdb\u7a0b\u72b6\u6001\npub is_zombie: bool,\n/// \u9000\u51fa\u72b6\u6001\u7801\npub exit_code: i32,\n/// \u6587\u4ef6\u7ba1\u7406\u5668\uff0c\u5b58\u50a8\u5982\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u5185\u5bb9\n#[cfg(feature = \"fs\")]\npub fd_manager: FdManager,\n/// \u8fdb\u7a0b\u5de5\u4f5c\u76ee\u5f55\npub cwd: String,\n#[cfg(feature = \"signal\")]\n/// \u4fe1\u53f7\u5904\u7406\u6a21\u5757    \n/// \u7b2c\u4e00\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0c\u7b2c\u4e8c\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4fe1\u53f7\u5904\u7406\u6a21\u5757\npub signal_module: BTreeMap&lt;u64, SignalModule&gt;,\n\n/// robust list\u5b58\u50a8\u6a21\u5757\n/// \u7528\u6765\u5b58\u50a8\u7ebf\u7a0b\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u4f7f\u7528\u5730\u5740\n/// \u5177\u4f53\u4f7f\u7528\u4ea4\u7ed9\u4e86\u7528\u6237\u7a7a\u95f4\npub robust_list: BTreeMap&lt;u64, FutexRobustList&gt;,\n}\n</code></pre> <p>\u4efb\u52a1\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>/// The inner task structure.\npub struct TaskInner {\nid: TaskId,\nname: String,\nis_idle: bool,\nis_init: bool,\n/// \u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\uff0c\u4ec5\u5728\u5185\u6838\u6001\u4e0b\u6709\u6548\nentry: Option&lt;*mut dyn FnOnce()&gt;,\nstate: AtomicU8,\n\nin_wait_queue: AtomicBool,\n#[cfg(feature = \"irq\")]\nin_timer_list: AtomicBool,\n\n#[cfg(feature = \"preempt\")]\nneed_resched: AtomicBool,\n#[cfg(feature = \"preempt\")]\npub preempt_disable_count: AtomicUsize,\n\nexit_code: AtomicI32,\nwait_for_exit: WaitQueue,\n/// \u5185\u6838\u6808\uff0c\u5bf9\u4e8eunikernel\u4e0d\u9700\u8981\n#[cfg(feature = \"monolithic\")]\nkstack: Option&lt;TaskStack&gt;,\n\nctx: UnsafeCell&lt;TaskContext&gt;,\n\n#[cfg(feature = \"monolithic\")]\n// \u5bf9\u5e94\u8fdb\u7a0bID\nprocess_id: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u662f\u5426\u662f\u6240\u5c5e\u8fdb\u7a0b\u4e0b\u7684\u4e3b\u7ebf\u7a0b\nis_leader: AtomicBool,\n\n#[cfg(feature = \"monolithic\")]\n// \u6240\u5c5e\u9875\u8868ID\uff0c\u5728\u5b8f\u5185\u6838\u4e0b\u9ed8\u8ba4\u4f1a\u5f00\u542f\u5206\u9875\uff0c\u662f\u53ea\u8bfb\u7684\u6240\u4ee5\u4e0d\u7528\u539f\u5b50\u91cf\npage_table_token: usize,\n\n#[cfg(feature = \"monolithic\")]\n/// \u521d\u59cb\u5316\u7684trap\u4e0a\u4e0b\u6587\npub trap_frame: UnsafeCell&lt;TrapFrame&gt;,\n// \u65f6\u95f4\u7edf\u8ba1\n#[cfg(feature = \"monolithic\")]\ntime: UnsafeCell&lt;TimeStat&gt;,\n\n#[allow(unused)]\n#[cfg(feature = \"monolithic\")]\n/// \u5b50\u7ebf\u7a0b\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u5b58\u653etid\u7684\u5730\u5740\nset_child_tid: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u5b50\u7ebf\u7a0b\u521d\u59cb\u5316\u65f6\uff0c\u5c06\u8fd9\u4e2a\u5730\u5740\u6e05\u7a7a\uff1b\u5b50\u7ebf\u7a0b\u9000\u51fa\u65f6\uff0c\u89e6\u53d1\u8fd9\u91cc\u7684 futex\u3002\n/// \u5728\u521b\u5efa\u65f6\u5305\u542b CLONE_CHILD_SETTID \u65f6\u624d\u975e0\uff0c\u4f46\u53ef\u4ee5\u88ab sys_set_tid_address \u4fee\u6539\nclear_child_tid: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u9000\u51fa\u65f6\u662f\u5426\u5411\u7236\u8fdb\u7a0b\u53d1\u9001SIG_CHILD\npub send_sigchld_when_exit: bool,\n}\n</code></pre> <p>\u8be5\u79cd\u8bbe\u8ba1\u7684\u4f18\u52bf\u5982\u4e0b\uff1a</p> <ul> <li>\u4fdd\u7559\u4e86 ArceOS \u7684\u7ed3\u6784\uff0c\u53ef\u4ee5\u8f83\u4e3a\u65b9\u4fbf\u5730\u4e0e\u5176\u4ed6\u540c\u5b66\u5f00\u53d1\u7ed3\u679c\u8fdb\u884c\u7ed3\u5408</li> <li>\u8026\u5408\u5ea6\u4f4e\uff0c\u56e0\u6b64\u53ef\u4ee5\u4f7f\u5185\u6838\u8f83\u4e3a\u65b9\u4fbf\u5730\u5728\u4e0d\u540c\u6a21\u5f0f\u95f4\u8fdb\u884c\u5207\u6362</li> </ul> <p>\u5728\u8be5\u79cd\u8bbe\u8ba1\u67b6\u6784\u4e0b\uff0c\u63a5\u53d7\u5916\u6765\u7cfb\u7edf\u8c03\u7528\u65f6\uff0c\u9700\u8981\u5c06\u90e8\u5206\u5bf9\u7ebf\u7a0b\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\u8f6c\u53d1\u7ed9\u8fdb\u7a0b\u3002\u8fdb\u7a0b\u6536 \u5230\u8be5\u7cfb\u7edf\u8c03\u7528\u4e4b\u540e\uff0c\u518d\u5bf9\u5f53\u524d\u8fdb\u7a0b\u4e0b\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\u8fdb\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\u3002\u5b9e\u4f8b\u4e3a yield \uff0c exit \u7b49\u3002</p> <p>\u5728\u751f\u6210\u65b0\u7684\u4efb\u52a1\u65f6\uff0c\u7531\u4e8e\u662f\u901a\u8fc7Linux\u7684clone\u8c03\u7528\u751f\u6210\u65b0\u7684\u4efb\u52a1\uff0c\u56e0\u6b64\u53ef\u4ee5\u6839\u636eclone\u7684\u53c2\u6570\u5224\u65ad\u751f\u6210\u7684\u662f\u65b0\u7684\u8fdb\u7a0b\u8fd8\u662f\u7ebf\u7a0b\uff0c\u4ece\u800c\u786e\u5b9a\u7ebf\u7a0b\u6240\u5c5e\u7684\u8fdb\u7a0b\u662f\u54ea\u4e00\u4e2a\uff0c\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b\u4e4b\u95f4\u5f62\u6210\u7236\u5b50\u5173\u7cfb\uff0c\u800c\u540c\u4e00\u8fdb\u7a0b\u4e0b\u7684\u7ebf\u7a0b\u5f62\u6210\u5144\u5f1f\u5173\u7cfb\uff0c\u4ece\u800c\u53ef\u4ee5\u66f4\u52a0\u65b9\u4fbf\u5730\u8fdb\u884c\u7ba1\u7406\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#_2","title":"\u5730\u5740\u7a7a\u95f4\u5f15\u5165","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#_3","title":"\u4efb\u52a1\u5207\u6362","text":"<p>\u5f15\u5165\u4e86\u8fdb\u7a0b\u4e4b\u540e\uff0c\u7531\u4e8e\u8fdb\u7a0b\u662f\u8d44\u6e90\u5bb9\u5668\u96c6\u5408\uff0c\u56e0\u6b64\u5730\u5740\u7a7a\u95f4\u76f8\u5173\u7684\u5b58\u50a8\u7ed3\u6784\u4e5f\u5b58\u653e\u5728\u8fd9\u91cc\uff0c\u4e0d\u540c\u8fdb\u7a0b\u4e4b\u95f4\u53ef\u4ee5\u5171\u4eab\u6216\u8005\u72ec\u4eab\u5730\u5740\u7a7a\u95f4\uff0c\u56e0\u6b64\u5728\u5207\u6362\u4efb\u52a1\u65f6\uff0c\u53ea\u9700\u8981\u989d\u5916\u5224\u65ad\u5f53\u524d\u6240\u5c5e\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\u7684token\u662f\u5426\u53d1\u751f\u6539\u53d8\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u591a\u5730\u5740\u7a7a\u95f4\u7684\u5f15\u5165\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#_4","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u76ee\u524d\u5185\u6838\u548c\u7528\u6237\u6001\u4f7f\u7528\u7684\u662f\u540c\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\uff0c\u53ef\u4ee5\u907f\u514dtrap\u65f6\u66f4\u6539\u9875\u8868\uff0c\u51cf\u5c11\u65f6\u7a7a\u635f\u8017\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#_5","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u5728Starry\u4e2d\uff0c\u5404\u79cd\u6d4b\u4f8b\u8fd0\u884c\u5728\u7528\u6237\u6001\u4e0b\uff0c\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u7684\u65b9\u5f0f\u6709\u4e24\u4e2a\uff1a\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u548ctrap\u8fd4\u56de\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#_6","title":"\u521d\u59cb\u5316\u8fdb\u5165","text":"<p>\u5bf9\u4e8e\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u90e8\u5206\uff0c\u5373\u662f\u5728\u539f\u6709ArceOS\u57fa\u7840\u4e0a\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u5224\u65ad\uff1a</p> <p>\u5224\u65ad\u7684\u539f\u5219\u5982\u4e0b\uff1a\u82e5\u8981\u6267\u884c\u7684\u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\u5728\u5185\u6838\u6001\uff0c\u5219\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002\u5426\u5219\u9700\u8981\u901a\u8fc7\u624b\u5199\u6c47\u7f16\u4ee3\u7801\u4fdd\u5b58\u5bc4\u5b58\u5668\uff0c\u4ee5\u7c7b\u4f3ctrap\u8fd4\u56de\u7684\u673a\u5236\u8c03\u7528sret\u8fdb\u5165\u7528\u6237\u6001\u6267\u884c\u5bf9\u5e94\u7684\u51fd\u6570\u3002</p> <pre><code>extern \"C\" fn task_entry() {\n// release the lock that was implicitly held across the reschedule\nunsafe { crate::RUN_QUEUE.force_unlock() };\naxhal::arch::enable_irqs();\nlet task: CurrentTask = crate::current();\nif let Some(entry) = task.entry {\nif task.get_process_id() == KERNEL_PROCESS_ID {\n// \u5bf9\u4e8eunikernel\uff0c\u8fd9\u91cc\u662f\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\uff0c\u7531\u4e8e\u90fd\u5728\u5185\u6838\u6001\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u51fd\u6570\n// \u5bf9\u4e8e\u5b8f\u5185\u6838\uff0c\u8fd9\u662f\u521d\u59cb\u8c03\u5ea6\u8fdb\u7a0b\uff0c\u4e5f\u5728\u5185\u6838\u6001\uff0c\u76f4\u63a5\u6267\u884c\u5373\u53ef\nunsafe { Box::from_raw(entry)() };\n} else {\n// \u9700\u8981\u901a\u8fc7\u5207\u6362\u7279\u6743\u7ea7\u8fdb\u5165\u5230\u5bf9\u5e94\u7684\u5e94\u7528\u7a0b\u5e8f\nlet kernel_sp = task.get_kernel_stack_top().unwrap();\n\nlet frame_address = task.get_first_trap_frame();\n// \u5207\u6362\u9875\u8868\u5df2\u7ecf\u5728switch\u5b9e\u73b0\u4e86\nfirst_into_user(kernel_sp, frame_address as usize);\n}\n}\n// only for kernel task\ncrate::exit(0);\n}\n\n/// \u521d\u59cb\u5316\u4e3b\u8fdb\u7a0b\u7684trap\u4e0a\u4e0b\u6587\n#[no_mangle]\nfn first_into_user(kernel_sp: usize, frame_base: usize) -&gt; ! {\nlet trap_frame_size = core::mem::size_of::&lt;TrapFrame&gt;();\nlet kernel_base = kernel_sp - trap_frame_size;\n// \u5728\u4fdd\u8bc1\u5c06\u5bc4\u5b58\u5668\u90fd\u5b58\u50a8\u597d\u4e4b\u540e\uff0c\u518d\u5f00\u542f\u4e2d\u65ad\n// \u5426\u5219\u6b64\u65f6\u4f1a\u56e0\u4e3a\u5199\u5165csr\u5bc4\u5b58\u5668\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e2d\u65ad\uff0c\u5bfc\u81f4\u51fa\u73b0\u5f02\u5e38\naxhal::arch::disable_irqs();\n// \u5728\u5185\u6838\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u800c\u5f53\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u65f6\uff0c\u4f1a\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u5148\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5373\u628a\u8be5\u4efb\u52a1\u5bf9\u5e94\u7684CPU ID\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\n// \u7136\u540e\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u6539\u4e3a\u5bf9\u5e94\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u56e0\u6b64\u5728\u7528\u6237\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u503c\u662f\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u800c\u5f53\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\u65f6\uff0c\u4f1a\u5148\u5c06\u5185\u6838\u6808\u4e0a\u7684\u503c\u8bfb\u53d6\u5230\u67d0\u4e00\u4e2a\u4e2d\u95f4\u5bc4\u5b58\u5668t0\u4e2d\uff0c\u7136\u540e\u5c06tp\u7684\u503c\u5b58\u5165\u5185\u6838\u6808\n// \u7136\u540e\u518d\u5c06t0\u7684\u503c\u8d4b\u7ed9tp\uff0c\u56e0\u6b64\u6b64\u65f6tp\u7684\u503c\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u5bf9\u5e94\u5b9e\u73b0\u5728axhal/src/arch/riscv/trap.S\u4e2d\nunsafe {\nasm::sfence_vma_all();\ncore::arch::asm!(\nr\"\n            mv      sp, {frame_base}\n            .short  0x2432                      // fld fs0,264(sp)\n            .short  0x24d2                      // fld fs1,272(sp)\n            LDR     gp, sp, 2                   // load user gp and tp\n            LDR     t0, sp, 3\n            mv      t1, {kernel_base}\n            STR     tp, t1, 3                   // save supervisor tp\uff0c\u6ce8\u610f\u662f\u5b58\u50a8\u5230\u5185\u6838\u6808\u4e0a\u800c\u4e0d\u662fsp\u4e2d\uff0c\u6b64\u65f6\u5b58\u50a8\u7684\u5e94\u8be5\u662f\u5f53\u524d\u8fd0\u884c\u7684CPU\u7684ID\n            mv      tp, t0                      // tp\uff1a\u672c\u6765\u5b58\u50a8\u7684\u662fCPU ID\uff0c\u5728\u8fd9\u4e2a\u65f6\u5019\u53d8\u6210\u4e86\u5bf9\u5e94\u7ebf\u7a0b\u7684TLS \u6307\u9488\n            csrw    sscratch, {kernel_sp}       // put supervisor sp to scratch\n            LDR     t0, sp, 31\n            LDR     t1, sp, 32\n            csrw    sepc, t0\n            csrw    sstatus, t1\n            POP_GENERAL_REGS\n            LDR     sp, sp, 1\n            sret\n        \",\nframe_base = in(reg) frame_base,\nkernel_sp = in(reg) kernel_sp,\nkernel_base = in(reg) kernel_base,\n);\n};\ncore::panic!(\"already in user mode!\")\n}\n</code></pre>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.1%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86/#trap","title":"trap\u5207\u6362","text":"<p>trap\u5207\u6362\u5bf9\u5e94\u7684\u6c47\u7f16\u4ee3\u7801\u5728<code>axhal/src/arch/riscv</code>\uff0c\u503c\u5f97\u5173\u6ce8\u7684\u662f\u5176\u5d4c\u5957trap\u7684\u5904\u7406\u3002\u5728\u7b2c\u4e00\u6b21\u8fdb\u5165trap\u65f6\uff0c\u662f\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\uff0c\u6b64\u65f6\u4f1a\u5c06\u5185\u6838\u6808\u7684\u5730\u5740\u8d4b\u7ed9sp\uff0c\u5c06\u7528\u6237\u6808\u7684\u5730\u5740\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5e76\u5c06sscratch\u6e05\u96f6\u3002\u82e5\u53d1\u751f\u5185\u6838\u5d4c\u5957trap\uff0c\u5219\u6b64\u65f6sscratch\u7684\u503c\u4e3a0\uff0c\u4e0esp\u4ea4\u6362\u4e4b\u540e\uff0csp\u4e3a0\uff0c\u5373\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p> <p>\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u4ea4\u6362\u4e4b\u540esp\u662f\u5426\u4e3a0\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/","title":"3.2 \u8fdb\u7a0b\u5f15\u5165","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/#_1","title":"\u5730\u5740\u7a7a\u95f4\u5f15\u5165","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/#_2","title":"\u4efb\u52a1\u5207\u6362","text":"<p>\u5f15\u5165\u4e86\u8fdb\u7a0b\u4e4b\u540e\uff0c\u7531\u4e8e\u8fdb\u7a0b\u662f\u8d44\u6e90\u5bb9\u5668\u96c6\u5408\uff0c\u56e0\u6b64\u5730\u5740\u7a7a\u95f4\u76f8\u5173\u7684\u5b58\u50a8\u7ed3\u6784\u4e5f\u5b58\u653e\u5728\u8fd9\u91cc\uff0c\u4e0d\u540c\u8fdb\u7a0b\u4e4b\u95f4\u53ef\u4ee5\u5171\u4eab\u6216\u8005\u72ec\u4eab\u5730\u5740\u7a7a\u95f4\uff0c\u56e0\u6b64\u5728\u5207\u6362\u4efb\u52a1\u65f6\uff0c\u53ea\u9700\u8981\u989d\u5916\u5224\u65ad\u5f53\u524d\u6240\u5c5e\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\u7684token\u662f\u5426\u53d1\u751f\u6539\u53d8\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u591a\u5730\u5740\u7a7a\u95f4\u7684\u5f15\u5165\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/#_3","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u76ee\u524d\u5185\u6838\u548c\u7528\u6237\u6001\u4f7f\u7528\u7684\u662f\u540c\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\uff0c\u53ef\u4ee5\u907f\u514dtrap\u65f6\u66f4\u6539\u9875\u8868\uff0c\u51cf\u5c11\u65f6\u7a7a\u635f\u8017\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/#_4","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u5728Starry\u4e2d\uff0c\u5404\u79cd\u6d4b\u4f8b\u8fd0\u884c\u5728\u7528\u6237\u6001\u4e0b\uff0c\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u7684\u65b9\u5f0f\u6709\u4e24\u4e2a\uff1a\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u548ctrap\u8fd4\u56de\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/#_5","title":"\u521d\u59cb\u5316\u8fdb\u5165","text":"<p>\u5bf9\u4e8e\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u90e8\u5206\uff0c\u5373\u662f\u5728\u539f\u6709ArceOS\u57fa\u7840\u4e0a\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u5224\u65ad\uff1a</p> <p>\u5224\u65ad\u7684\u539f\u5219\u5982\u4e0b\uff1a\u82e5\u8981\u6267\u884c\u7684\u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\u5728\u5185\u6838\u6001\uff0c\u5219\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002\u5426\u5219\u9700\u8981\u901a\u8fc7\u624b\u5199\u6c47\u7f16\u4ee3\u7801\u4fdd\u5b58\u5bc4\u5b58\u5668\uff0c\u4ee5\u7c7b\u4f3ctrap\u8fd4\u56de\u7684\u673a\u5236\u8c03\u7528sret\u8fdb\u5165\u7528\u6237\u6001\u6267\u884c\u5bf9\u5e94\u7684\u51fd\u6570\u3002</p> <pre><code>extern \"C\" fn task_entry() {\n// release the lock that was implicitly held across the reschedule\nunsafe { crate::RUN_QUEUE.force_unlock() };\naxhal::arch::enable_irqs();\nlet task: CurrentTask = crate::current();\nif let Some(entry) = task.entry {\nif task.get_process_id() == KERNEL_PROCESS_ID {\n// \u5bf9\u4e8eunikernel\uff0c\u8fd9\u91cc\u662f\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\uff0c\u7531\u4e8e\u90fd\u5728\u5185\u6838\u6001\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u51fd\u6570\n// \u5bf9\u4e8e\u5b8f\u5185\u6838\uff0c\u8fd9\u662f\u521d\u59cb\u8c03\u5ea6\u8fdb\u7a0b\uff0c\u4e5f\u5728\u5185\u6838\u6001\uff0c\u76f4\u63a5\u6267\u884c\u5373\u53ef\nunsafe { Box::from_raw(entry)() };\n} else {\n// \u9700\u8981\u901a\u8fc7\u5207\u6362\u7279\u6743\u7ea7\u8fdb\u5165\u5230\u5bf9\u5e94\u7684\u5e94\u7528\u7a0b\u5e8f\nlet kernel_sp = task.get_kernel_stack_top().unwrap();\n\nlet frame_address = task.get_first_trap_frame();\n// \u5207\u6362\u9875\u8868\u5df2\u7ecf\u5728switch\u5b9e\u73b0\u4e86\nfirst_into_user(kernel_sp, frame_address as usize);\n}\n}\n// only for kernel task\ncrate::exit(0);\n}\n\n/// \u521d\u59cb\u5316\u4e3b\u8fdb\u7a0b\u7684trap\u4e0a\u4e0b\u6587\n#[no_mangle]\nfn first_into_user(kernel_sp: usize, frame_base: usize) -&gt; ! {\nlet trap_frame_size = core::mem::size_of::&lt;TrapFrame&gt;();\nlet kernel_base = kernel_sp - trap_frame_size;\n// \u5728\u4fdd\u8bc1\u5c06\u5bc4\u5b58\u5668\u90fd\u5b58\u50a8\u597d\u4e4b\u540e\uff0c\u518d\u5f00\u542f\u4e2d\u65ad\n// \u5426\u5219\u6b64\u65f6\u4f1a\u56e0\u4e3a\u5199\u5165csr\u5bc4\u5b58\u5668\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e2d\u65ad\uff0c\u5bfc\u81f4\u51fa\u73b0\u5f02\u5e38\naxhal::arch::disable_irqs();\n// \u5728\u5185\u6838\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u800c\u5f53\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u65f6\uff0c\u4f1a\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u5148\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5373\u628a\u8be5\u4efb\u52a1\u5bf9\u5e94\u7684CPU ID\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\n// \u7136\u540e\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u6539\u4e3a\u5bf9\u5e94\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u56e0\u6b64\u5728\u7528\u6237\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u503c\u662f\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u800c\u5f53\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\u65f6\uff0c\u4f1a\u5148\u5c06\u5185\u6838\u6808\u4e0a\u7684\u503c\u8bfb\u53d6\u5230\u67d0\u4e00\u4e2a\u4e2d\u95f4\u5bc4\u5b58\u5668t0\u4e2d\uff0c\u7136\u540e\u5c06tp\u7684\u503c\u5b58\u5165\u5185\u6838\u6808\n// \u7136\u540e\u518d\u5c06t0\u7684\u503c\u8d4b\u7ed9tp\uff0c\u56e0\u6b64\u6b64\u65f6tp\u7684\u503c\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u5bf9\u5e94\u5b9e\u73b0\u5728axhal/src/arch/riscv/trap.S\u4e2d\nunsafe {\nasm::sfence_vma_all();\ncore::arch::asm!(\nr\"\n            mv      sp, {frame_base}\n            .short  0x2432                      // fld fs0,264(sp)\n            .short  0x24d2                      // fld fs1,272(sp)\n            LDR     gp, sp, 2                   // load user gp and tp\n            LDR     t0, sp, 3\n            mv      t1, {kernel_base}\n            STR     tp, t1, 3                   // save supervisor tp\uff0c\u6ce8\u610f\u662f\u5b58\u50a8\u5230\u5185\u6838\u6808\u4e0a\u800c\u4e0d\u662fsp\u4e2d\uff0c\u6b64\u65f6\u5b58\u50a8\u7684\u5e94\u8be5\u662f\u5f53\u524d\u8fd0\u884c\u7684CPU\u7684ID\n            mv      tp, t0                      // tp\uff1a\u672c\u6765\u5b58\u50a8\u7684\u662fCPU ID\uff0c\u5728\u8fd9\u4e2a\u65f6\u5019\u53d8\u6210\u4e86\u5bf9\u5e94\u7ebf\u7a0b\u7684TLS \u6307\u9488\n            csrw    sscratch, {kernel_sp}       // put supervisor sp to scratch\n            LDR     t0, sp, 31\n            LDR     t1, sp, 32\n            csrw    sepc, t0\n            csrw    sstatus, t1\n            POP_GENERAL_REGS\n            LDR     sp, sp, 1\n            sret\n        \",\nframe_base = in(reg) frame_base,\nkernel_sp = in(reg) kernel_sp,\nkernel_base = in(reg) kernel_base,\n);\n};\ncore::panic!(\"already in user mode!\")\n}\n</code></pre>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.2%E8%BF%9B%E7%A8%8B%E5%BC%95%E5%85%A5/#trap","title":"trap\u5207\u6362","text":"<p>trap\u5207\u6362\u5bf9\u5e94\u7684\u6c47\u7f16\u4ee3\u7801\u5728<code>axhal/src/arch/riscv</code>\uff0c\u503c\u5f97\u5173\u6ce8\u7684\u662f\u5176\u5d4c\u5957trap\u7684\u5904\u7406\u3002\u5728\u7b2c\u4e00\u6b21\u8fdb\u5165trap\u65f6\uff0c\u662f\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\uff0c\u6b64\u65f6\u4f1a\u5c06\u5185\u6838\u6808\u7684\u5730\u5740\u8d4b\u7ed9sp\uff0c\u5c06\u7528\u6237\u6808\u7684\u5730\u5740\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5e76\u5c06sscratch\u6e05\u96f6\u3002\u82e5\u53d1\u751f\u5185\u6838\u5d4c\u5957trap\uff0c\u5219\u6b64\u65f6sscratch\u7684\u503c\u4e3a0\uff0c\u4e0esp\u4ea4\u6362\u4e4b\u540e\uff0csp\u4e3a0\uff0c\u5373\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p> <p>\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u4ea4\u6362\u4e4b\u540esp\u662f\u5426\u4e3a0\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.3%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%BC%95%E5%85%A5/","title":"3.3 \u5730\u5740\u7a7a\u95f4\u5f15\u5165","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.3%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%BC%95%E5%85%A5/#_1","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u5728Starry\u4e2d\uff0c\u5404\u79cd\u6d4b\u4f8b\u8fd0\u884c\u5728\u7528\u6237\u6001\u4e0b\uff0c\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u7684\u65b9\u5f0f\u6709\u4e24\u4e2a\uff1a\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u548ctrap\u8fd4\u56de\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.3%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%BC%95%E5%85%A5/#_2","title":"\u521d\u59cb\u5316\u8fdb\u5165","text":"<p>\u5bf9\u4e8e\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u90e8\u5206\uff0c\u5373\u662f\u5728\u539f\u6709ArceOS\u57fa\u7840\u4e0a\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u5224\u65ad\uff1a</p> <p>\u5224\u65ad\u7684\u539f\u5219\u5982\u4e0b\uff1a\u82e5\u8981\u6267\u884c\u7684\u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\u5728\u5185\u6838\u6001\uff0c\u5219\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002\u5426\u5219\u9700\u8981\u901a\u8fc7\u624b\u5199\u6c47\u7f16\u4ee3\u7801\u4fdd\u5b58\u5bc4\u5b58\u5668\uff0c\u4ee5\u7c7b\u4f3ctrap\u8fd4\u56de\u7684\u673a\u5236\u8c03\u7528sret\u8fdb\u5165\u7528\u6237\u6001\u6267\u884c\u5bf9\u5e94\u7684\u51fd\u6570\u3002</p> <pre><code>extern \"C\" fn task_entry() {\n// release the lock that was implicitly held across the reschedule\nunsafe { crate::RUN_QUEUE.force_unlock() };\naxhal::arch::enable_irqs();\nlet task: CurrentTask = crate::current();\nif let Some(entry) = task.entry {\nif task.get_process_id() == KERNEL_PROCESS_ID {\n// \u5bf9\u4e8eunikernel\uff0c\u8fd9\u91cc\u662f\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\uff0c\u7531\u4e8e\u90fd\u5728\u5185\u6838\u6001\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u51fd\u6570\n// \u5bf9\u4e8e\u5b8f\u5185\u6838\uff0c\u8fd9\u662f\u521d\u59cb\u8c03\u5ea6\u8fdb\u7a0b\uff0c\u4e5f\u5728\u5185\u6838\u6001\uff0c\u76f4\u63a5\u6267\u884c\u5373\u53ef\nunsafe { Box::from_raw(entry)() };\n} else {\n// \u9700\u8981\u901a\u8fc7\u5207\u6362\u7279\u6743\u7ea7\u8fdb\u5165\u5230\u5bf9\u5e94\u7684\u5e94\u7528\u7a0b\u5e8f\nlet kernel_sp = task.get_kernel_stack_top().unwrap();\n\nlet frame_address = task.get_first_trap_frame();\n// \u5207\u6362\u9875\u8868\u5df2\u7ecf\u5728switch\u5b9e\u73b0\u4e86\nfirst_into_user(kernel_sp, frame_address as usize);\n}\n}\n// only for kernel task\ncrate::exit(0);\n}\n\n/// \u521d\u59cb\u5316\u4e3b\u8fdb\u7a0b\u7684trap\u4e0a\u4e0b\u6587\n#[no_mangle]\nfn first_into_user(kernel_sp: usize, frame_base: usize) -&gt; ! {\nlet trap_frame_size = core::mem::size_of::&lt;TrapFrame&gt;();\nlet kernel_base = kernel_sp - trap_frame_size;\n// \u5728\u4fdd\u8bc1\u5c06\u5bc4\u5b58\u5668\u90fd\u5b58\u50a8\u597d\u4e4b\u540e\uff0c\u518d\u5f00\u542f\u4e2d\u65ad\n// \u5426\u5219\u6b64\u65f6\u4f1a\u56e0\u4e3a\u5199\u5165csr\u5bc4\u5b58\u5668\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e2d\u65ad\uff0c\u5bfc\u81f4\u51fa\u73b0\u5f02\u5e38\naxhal::arch::disable_irqs();\n// \u5728\u5185\u6838\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u800c\u5f53\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u65f6\uff0c\u4f1a\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u5148\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5373\u628a\u8be5\u4efb\u52a1\u5bf9\u5e94\u7684CPU ID\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\n// \u7136\u540e\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u6539\u4e3a\u5bf9\u5e94\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u56e0\u6b64\u5728\u7528\u6237\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u503c\u662f\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u800c\u5f53\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\u65f6\uff0c\u4f1a\u5148\u5c06\u5185\u6838\u6808\u4e0a\u7684\u503c\u8bfb\u53d6\u5230\u67d0\u4e00\u4e2a\u4e2d\u95f4\u5bc4\u5b58\u5668t0\u4e2d\uff0c\u7136\u540e\u5c06tp\u7684\u503c\u5b58\u5165\u5185\u6838\u6808\n// \u7136\u540e\u518d\u5c06t0\u7684\u503c\u8d4b\u7ed9tp\uff0c\u56e0\u6b64\u6b64\u65f6tp\u7684\u503c\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u5bf9\u5e94\u5b9e\u73b0\u5728axhal/src/arch/riscv/trap.S\u4e2d\nunsafe {\nasm::sfence_vma_all();\ncore::arch::asm!(\nr\"\n            mv      sp, {frame_base}\n            .short  0x2432                      // fld fs0,264(sp)\n            .short  0x24d2                      // fld fs1,272(sp)\n            LDR     gp, sp, 2                   // load user gp and tp\n            LDR     t0, sp, 3\n            mv      t1, {kernel_base}\n            STR     tp, t1, 3                   // save supervisor tp\uff0c\u6ce8\u610f\u662f\u5b58\u50a8\u5230\u5185\u6838\u6808\u4e0a\u800c\u4e0d\u662fsp\u4e2d\uff0c\u6b64\u65f6\u5b58\u50a8\u7684\u5e94\u8be5\u662f\u5f53\u524d\u8fd0\u884c\u7684CPU\u7684ID\n            mv      tp, t0                      // tp\uff1a\u672c\u6765\u5b58\u50a8\u7684\u662fCPU ID\uff0c\u5728\u8fd9\u4e2a\u65f6\u5019\u53d8\u6210\u4e86\u5bf9\u5e94\u7ebf\u7a0b\u7684TLS \u6307\u9488\n            csrw    sscratch, {kernel_sp}       // put supervisor sp to scratch\n            LDR     t0, sp, 31\n            LDR     t1, sp, 32\n            csrw    sepc, t0\n            csrw    sstatus, t1\n            POP_GENERAL_REGS\n            LDR     sp, sp, 1\n            sret\n        \",\nframe_base = in(reg) frame_base,\nkernel_sp = in(reg) kernel_sp,\nkernel_base = in(reg) kernel_base,\n);\n};\ncore::panic!(\"already in user mode!\")\n}\n</code></pre>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.3%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%BC%95%E5%85%A5/#trap","title":"trap\u5207\u6362","text":"<p>trap\u5207\u6362\u5bf9\u5e94\u7684\u6c47\u7f16\u4ee3\u7801\u5728<code>axhal/src/arch/riscv</code>\uff0c\u503c\u5f97\u5173\u6ce8\u7684\u662f\u5176\u5d4c\u5957trap\u7684\u5904\u7406\u3002\u5728\u7b2c\u4e00\u6b21\u8fdb\u5165trap\u65f6\uff0c\u662f\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\uff0c\u6b64\u65f6\u4f1a\u5c06\u5185\u6838\u6808\u7684\u5730\u5740\u8d4b\u7ed9sp\uff0c\u5c06\u7528\u6237\u6808\u7684\u5730\u5740\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5e76\u5c06sscratch\u6e05\u96f6\u3002\u82e5\u53d1\u751f\u5185\u6838\u5d4c\u5957trap\uff0c\u5219\u6b64\u65f6sscratch\u7684\u503c\u4e3a0\uff0c\u4e0esp\u4ea4\u6362\u4e4b\u540e\uff0csp\u4e3a0\uff0c\u5373\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p> <p>\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u4ea4\u6362\u4e4b\u540esp\u662f\u5426\u4e3a0\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.4%E7%89%B9%E6%9D%83%E7%BA%A7%E5%88%87%E6%8D%A2/","title":"3.4 \u7279\u6743\u7ea7\u5207\u6362","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.4%E7%89%B9%E6%9D%83%E7%BA%A7%E5%88%87%E6%8D%A2/#_1","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u5728Starry\u4e2d\uff0c\u5404\u79cd\u6d4b\u4f8b\u8fd0\u884c\u5728\u7528\u6237\u6001\u4e0b\uff0c\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u7684\u65b9\u5f0f\u6709\u4e24\u4e2a\uff1a\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u548ctrap\u8fd4\u56de\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.4%E7%89%B9%E6%9D%83%E7%BA%A7%E5%88%87%E6%8D%A2/#_2","title":"\u521d\u59cb\u5316\u8fdb\u5165","text":"<p>\u5bf9\u4e8e\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u90e8\u5206\uff0c\u5373\u662f\u5728\u539f\u6709ArceOS\u57fa\u7840\u4e0a\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u5224\u65ad\uff1a</p> <p>\u5224\u65ad\u7684\u539f\u5219\u5982\u4e0b\uff1a\u82e5\u8981\u6267\u884c\u7684\u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\u5728\u5185\u6838\u6001\uff0c\u5219\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002\u5426\u5219\u9700\u8981\u901a\u8fc7\u624b\u5199\u6c47\u7f16\u4ee3\u7801\u4fdd\u5b58\u5bc4\u5b58\u5668\uff0c\u4ee5\u7c7b\u4f3ctrap\u8fd4\u56de\u7684\u673a\u5236\u8c03\u7528sret\u8fdb\u5165\u7528\u6237\u6001\u6267\u884c\u5bf9\u5e94\u7684\u51fd\u6570\u3002</p> <pre><code>extern \"C\" fn task_entry() {\n// release the lock that was implicitly held across the reschedule\nunsafe { crate::RUN_QUEUE.force_unlock() };\naxhal::arch::enable_irqs();\nlet task: CurrentTask = crate::current();\nif let Some(entry) = task.entry {\nif task.get_process_id() == KERNEL_PROCESS_ID {\n// \u5bf9\u4e8eunikernel\uff0c\u8fd9\u91cc\u662f\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\uff0c\u7531\u4e8e\u90fd\u5728\u5185\u6838\u6001\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u51fd\u6570\n// \u5bf9\u4e8e\u5b8f\u5185\u6838\uff0c\u8fd9\u662f\u521d\u59cb\u8c03\u5ea6\u8fdb\u7a0b\uff0c\u4e5f\u5728\u5185\u6838\u6001\uff0c\u76f4\u63a5\u6267\u884c\u5373\u53ef\nunsafe { Box::from_raw(entry)() };\n} else {\n// \u9700\u8981\u901a\u8fc7\u5207\u6362\u7279\u6743\u7ea7\u8fdb\u5165\u5230\u5bf9\u5e94\u7684\u5e94\u7528\u7a0b\u5e8f\nlet kernel_sp = task.get_kernel_stack_top().unwrap();\n\nlet frame_address = task.get_first_trap_frame();\n// \u5207\u6362\u9875\u8868\u5df2\u7ecf\u5728switch\u5b9e\u73b0\u4e86\nfirst_into_user(kernel_sp, frame_address as usize);\n}\n}\n// only for kernel task\ncrate::exit(0);\n}\n\n/// \u521d\u59cb\u5316\u4e3b\u8fdb\u7a0b\u7684trap\u4e0a\u4e0b\u6587\n#[no_mangle]\nfn first_into_user(kernel_sp: usize, frame_base: usize) -&gt; ! {\nlet trap_frame_size = core::mem::size_of::&lt;TrapFrame&gt;();\nlet kernel_base = kernel_sp - trap_frame_size;\n// \u5728\u4fdd\u8bc1\u5c06\u5bc4\u5b58\u5668\u90fd\u5b58\u50a8\u597d\u4e4b\u540e\uff0c\u518d\u5f00\u542f\u4e2d\u65ad\n// \u5426\u5219\u6b64\u65f6\u4f1a\u56e0\u4e3a\u5199\u5165csr\u5bc4\u5b58\u5668\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e2d\u65ad\uff0c\u5bfc\u81f4\u51fa\u73b0\u5f02\u5e38\naxhal::arch::disable_irqs();\n// \u5728\u5185\u6838\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u800c\u5f53\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u65f6\uff0c\u4f1a\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u5148\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5373\u628a\u8be5\u4efb\u52a1\u5bf9\u5e94\u7684CPU ID\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\n// \u7136\u540e\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u6539\u4e3a\u5bf9\u5e94\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u56e0\u6b64\u5728\u7528\u6237\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u503c\u662f\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u800c\u5f53\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\u65f6\uff0c\u4f1a\u5148\u5c06\u5185\u6838\u6808\u4e0a\u7684\u503c\u8bfb\u53d6\u5230\u67d0\u4e00\u4e2a\u4e2d\u95f4\u5bc4\u5b58\u5668t0\u4e2d\uff0c\u7136\u540e\u5c06tp\u7684\u503c\u5b58\u5165\u5185\u6838\u6808\n// \u7136\u540e\u518d\u5c06t0\u7684\u503c\u8d4b\u7ed9tp\uff0c\u56e0\u6b64\u6b64\u65f6tp\u7684\u503c\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u5bf9\u5e94\u5b9e\u73b0\u5728axhal/src/arch/riscv/trap.S\u4e2d\nunsafe {\nasm::sfence_vma_all();\ncore::arch::asm!(\nr\"\n            mv      sp, {frame_base}\n            .short  0x2432                      // fld fs0,264(sp)\n            .short  0x24d2                      // fld fs1,272(sp)\n            LDR     gp, sp, 2                   // load user gp and tp\n            LDR     t0, sp, 3\n            mv      t1, {kernel_base}\n            STR     tp, t1, 3                   // save supervisor tp\uff0c\u6ce8\u610f\u662f\u5b58\u50a8\u5230\u5185\u6838\u6808\u4e0a\u800c\u4e0d\u662fsp\u4e2d\uff0c\u6b64\u65f6\u5b58\u50a8\u7684\u5e94\u8be5\u662f\u5f53\u524d\u8fd0\u884c\u7684CPU\u7684ID\n            mv      tp, t0                      // tp\uff1a\u672c\u6765\u5b58\u50a8\u7684\u662fCPU ID\uff0c\u5728\u8fd9\u4e2a\u65f6\u5019\u53d8\u6210\u4e86\u5bf9\u5e94\u7ebf\u7a0b\u7684TLS \u6307\u9488\n            csrw    sscratch, {kernel_sp}       // put supervisor sp to scratch\n            LDR     t0, sp, 31\n            LDR     t1, sp, 32\n            csrw    sepc, t0\n            csrw    sstatus, t1\n            POP_GENERAL_REGS\n            LDR     sp, sp, 1\n            sret\n        \",\nframe_base = in(reg) frame_base,\nkernel_sp = in(reg) kernel_sp,\nkernel_base = in(reg) kernel_base,\n);\n};\ncore::panic!(\"already in user mode!\")\n}\n</code></pre>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.4%E7%89%B9%E6%9D%83%E7%BA%A7%E5%88%87%E6%8D%A2/#trap","title":"trap\u5207\u6362","text":"<p>trap\u5207\u6362\u5bf9\u5e94\u7684\u6c47\u7f16\u4ee3\u7801\u5728<code>axhal/src/arch/riscv</code>\uff0c\u503c\u5f97\u5173\u6ce8\u7684\u662f\u5176\u5d4c\u5957trap\u7684\u5904\u7406\u3002\u5728\u7b2c\u4e00\u6b21\u8fdb\u5165trap\u65f6\uff0c\u662f\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\uff0c\u6b64\u65f6\u4f1a\u5c06\u5185\u6838\u6808\u7684\u5730\u5740\u8d4b\u7ed9sp\uff0c\u5c06\u7528\u6237\u6808\u7684\u5730\u5740\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5e76\u5c06sscratch\u6e05\u96f6\u3002\u82e5\u53d1\u751f\u5185\u6838\u5d4c\u5957trap\uff0c\u5219\u6b64\u65f6sscratch\u7684\u503c\u4e3a0\uff0c\u4e0esp\u4ea4\u6362\u4e4b\u540e\uff0csp\u4e3a0\uff0c\u5373\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p> <p>\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u4ea4\u6362\u4e4b\u540esp\u662f\u5426\u4e3a0\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/","title":"3.\u8bbe\u8ba1\u601d\u8def","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_1","title":"\u6a21\u5757\u5212\u5206","text":"<p>\u4f9d\u636e\u6a21\u5757\u5316\u5185\u6838\u7684\u8bbe\u8ba1\u601d\u60f3\uff0c\u6211\u4eec\u671f\u671b\u6211\u4eec\u7684\u5185\u6838\u80fd\u591f\u5728\u5c3d\u53ef\u80fd\u4fdd\u7559\u539f\u6709unikernel\u7684\u57fa\u7840\u4e0a\u540c\u65f6\u517c\u5bb9\u5b8f\u5185\u6838\u529f\u80fd\uff0c\u56e0\u6b64\u6211\u4eec\u5728arceos\u7684\u57fa\u7840\u4e0a\u65b0\u589e\u4e86\u5982\u4e0b\u6a21\u5757\uff1a</p> <ul> <li>axmem\uff1a\u5f15\u5165\u5730\u5740\u7a7a\u95f4</li> <li>axtask/monolithic_task\uff1a\u4fee\u6539\u539f\u6709task\u6a21\u5757\uff0c\u6dfb\u52a0\u4e86\u66f4\u591a\u4efb\u52a1\u72b6\u6001\uff0c\u4ece\u800c\u4f7f\u5f97\u4efb\u52a1\u53ef\u4ee5\u4f5c\u4e3a\u7ebf\u7a0b\u7684\u5f62\u5f0f\u88ab\u8fdb\u7a0b\u8c03\u5ea6</li> <li>axsignal\uff1a\u4fe1\u53f7\u6a21\u5757</li> <li>axprocess\uff1a\u5f15\u5165\u8fdb\u7a0b\u6982\u5ff5\uff0c\u652f\u6301\u591a\u8fdb\u7a0b\u591a\u7ebf\u7a0b\u8fd0\u884c\uff0c\u6dfb\u52a0\u4e86\u5f88\u591a\u4e0eLinux\u7cfb\u7edf\u8c03\u7528\u76f8\u5173\u7684\u5185\u5bb9</li> <li>starry_libax\uff1aLinux\u7cfb\u7edf\u8c03\u7528\u7528\u6237\u5e93\uff0c\u5305\u88c5\u4e86\u4f5c\u4e3aLinux\u517c\u5bb9\u5c42\u7684\u4f17\u591a\u5bf9\u5916\u63a5\u53e3\u3002</li> </ul>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_2","title":"\u8fdb\u7a0b\u5f15\u5165","text":"<p>\u4e3a\u4e86\u8fd0\u884cLinux\u76f8\u5173\u7684\u5e94\u7528\uff0c\u6211\u4eec\u9700\u8981\u8ba9\u4e0d\u540c\u4efb\u52a1\u4e4b\u95f4\u5b58\u5728\u7236\u5b50\u7b49\u5173\u7cfb\uff0c\u56e0\u6b64\u6211\u4eec\u5f15\u5165\u4e86\u8fdb\u7a0b\u7684\u6982\u5ff5\u3002\u5728\u6807\u51c6\u7684Linux\u4e2d\uff0c\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u7edf\u4e00\u7528pthread\u7ed3\u6784\u4f53\u4ee3\u66ff\uff0c\u4f46\u6211\u4eec\u4e3a\u4e86\u4fdd\u8bc1\u539f\u6709arceos\u7684\u4efb\u52a1\u8c03\u5ea6\u7ed3\u6784\u4e0d\u53d7\u8fc7\u5927\u5f71\u54cd\uff0c\u56e0\u6b64\u9009\u62e9\u5c06\u8fdb\u7a0b\u548c\u7ebf\u7a0b\u8fdb\u884c\u5206\u79bb\uff0c\u8fdb\u7a0b\u4fdd\u5b58\u5728\u72ec\u7acb\u7684\u7ed3\u6784\u4f53<code>Process</code>\u4e2d\u3002</p> <p>\u4f9d\u636e\u6a21\u5757\u5316\u7684\u601d\u60f3\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u8fdb\u7a0b\u89c6\u4e3a\u4e00\u4e2a\u5bb9\u5668\uff0c\u5b58\u50a8\u4e86\u5404\u7c7b\u8fd0\u884c\u65f6\u8d44\u6e90\uff0c\u5305\u62ec\u865a\u5b58\u3001\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u7ebf\u7a0b\u3001\u4fe1\u53f7\u7b49\u3002 \u5728\u8be5\u79cd\u8bbe\u8ba1\u7406\u5ff5\u4e0b\uff0c\u8fdb\u7a0b\u4ec5\u662f\u5bf9\u4e0a\u8ff0\u8d44\u6e90\u7684\u4e00\u4e2a\u7edf\u4e00\u4e0e\u5305\u88c5\u3002\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0 feature \u7b49\u65b9\u5f0f\u5c06\u8fdb\u7a0b\u4f5c\u4e3a\u4e00\u4e2a\u53ef\u63d2\u62d4\u6a21\u5757\uff0c\u4f7f\u5f97\u5185\u6838\u5728\u5b8f\u5185\u6838\u67b6\u6784\u4e0e\u5fae\u5185\u6838\u67b6\u6784\u4e2d\u968f\u65f6\u8fdb\u884c\u5207\u6362\u3002</p> <p>\u8fdb\u7a0b\u7ed3\u6784\u8bbe\u8ba1\u5982\u4e0b\uff1a</p> <pre><code>pub struct ProcessInner {\n/// \u7236\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7\npub parent: u64,\n/// \u5b50\u8fdb\u7a0b\npub children: Vec&lt;Arc&lt;Process&gt;&gt;,\n/// \u5b50\u4efb\u52a1\npub tasks: Vec&lt;AxTaskRef&gt;,\n/// \u5730\u5740\u7a7a\u95f4\uff0c\u7531\u4e8e\u5b58\u5728\u5730\u5740\u7a7a\u95f4\u5171\u4eab\uff0c\u56e0\u6b64\u8bbe\u8ba1\u4e3aArc\u7c7b\u578b\npub memory_set: Arc&lt;SpinNoIrq&lt;MemorySet&gt;&gt;,\n/// \u7528\u6237\u5806\u57fa\u5740\uff0c\u4efb\u4f55\u65f6\u5019\u5806\u9876\u90fd\u4e0d\u80fd\u6bd4\u8fd9\u4e2a\u503c\u5c0f\uff0c\u7406\u8bba\u4e0a\u8bb2\u662f\u4e00\u4e2a\u5e38\u91cf\npub heap_bottom: usize,\n/// \u5f53\u524d\u7528\u6237\u5806\u7684\u5806\u9876\uff0c\u4e0d\u80fd\u5c0f\u4e8e\u57fa\u5740\uff0c\u4e0d\u80fd\u5927\u4e8e\u57fa\u5740\u52a0\u5806\u7684\u6700\u5927\u5927\u5c0f\npub heap_top: usize,\n/// \u8fdb\u7a0b\u72b6\u6001\npub is_zombie: bool,\n/// \u9000\u51fa\u72b6\u6001\u7801\npub exit_code: i32,\n/// \u6587\u4ef6\u7ba1\u7406\u5668\uff0c\u5b58\u50a8\u5982\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u5185\u5bb9\n#[cfg(feature = \"fs\")]\npub fd_manager: FdManager,\n/// \u8fdb\u7a0b\u5de5\u4f5c\u76ee\u5f55\npub cwd: String,\n#[cfg(feature = \"signal\")]\n/// \u4fe1\u53f7\u5904\u7406\u6a21\u5757    \n/// \u7b2c\u4e00\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0c\u7b2c\u4e8c\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4fe1\u53f7\u5904\u7406\u6a21\u5757\npub signal_module: BTreeMap&lt;u64, SignalModule&gt;,\n\n/// robust list\u5b58\u50a8\u6a21\u5757\n/// \u7528\u6765\u5b58\u50a8\u7ebf\u7a0b\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u4f7f\u7528\u5730\u5740\n/// \u5177\u4f53\u4f7f\u7528\u4ea4\u7ed9\u4e86\u7528\u6237\u7a7a\u95f4\npub robust_list: BTreeMap&lt;u64, FutexRobustList&gt;,\n}\n</code></pre> <p>\u4efb\u52a1\u7ed3\u6784\u5982\u4e0b\uff1a</p> <pre><code>/// The inner task structure.\npub struct TaskInner {\nid: TaskId,\nname: String,\nis_idle: bool,\nis_init: bool,\n/// \u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\uff0c\u4ec5\u5728\u5185\u6838\u6001\u4e0b\u6709\u6548\nentry: Option&lt;*mut dyn FnOnce()&gt;,\nstate: AtomicU8,\n\nin_wait_queue: AtomicBool,\n#[cfg(feature = \"irq\")]\nin_timer_list: AtomicBool,\n\n#[cfg(feature = \"preempt\")]\nneed_resched: AtomicBool,\n#[cfg(feature = \"preempt\")]\npub preempt_disable_count: AtomicUsize,\n\nexit_code: AtomicI32,\nwait_for_exit: WaitQueue,\n/// \u5185\u6838\u6808\uff0c\u5bf9\u4e8eunikernel\u4e0d\u9700\u8981\n#[cfg(feature = \"monolithic\")]\nkstack: Option&lt;TaskStack&gt;,\n\nctx: UnsafeCell&lt;TaskContext&gt;,\n\n#[cfg(feature = \"monolithic\")]\n// \u5bf9\u5e94\u8fdb\u7a0bID\nprocess_id: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u662f\u5426\u662f\u6240\u5c5e\u8fdb\u7a0b\u4e0b\u7684\u4e3b\u7ebf\u7a0b\nis_leader: AtomicBool,\n\n#[cfg(feature = \"monolithic\")]\n// \u6240\u5c5e\u9875\u8868ID\uff0c\u5728\u5b8f\u5185\u6838\u4e0b\u9ed8\u8ba4\u4f1a\u5f00\u542f\u5206\u9875\uff0c\u662f\u53ea\u8bfb\u7684\u6240\u4ee5\u4e0d\u7528\u539f\u5b50\u91cf\npage_table_token: usize,\n\n#[cfg(feature = \"monolithic\")]\n/// \u521d\u59cb\u5316\u7684trap\u4e0a\u4e0b\u6587\npub trap_frame: UnsafeCell&lt;TrapFrame&gt;,\n// \u65f6\u95f4\u7edf\u8ba1\n#[cfg(feature = \"monolithic\")]\ntime: UnsafeCell&lt;TimeStat&gt;,\n\n#[allow(unused)]\n#[cfg(feature = \"monolithic\")]\n/// \u5b50\u7ebf\u7a0b\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u5b58\u653etid\u7684\u5730\u5740\nset_child_tid: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u5b50\u7ebf\u7a0b\u521d\u59cb\u5316\u65f6\uff0c\u5c06\u8fd9\u4e2a\u5730\u5740\u6e05\u7a7a\uff1b\u5b50\u7ebf\u7a0b\u9000\u51fa\u65f6\uff0c\u89e6\u53d1\u8fd9\u91cc\u7684 futex\u3002\n/// \u5728\u521b\u5efa\u65f6\u5305\u542b CLONE_CHILD_SETTID \u65f6\u624d\u975e0\uff0c\u4f46\u53ef\u4ee5\u88ab sys_set_tid_address \u4fee\u6539\nclear_child_tid: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u9000\u51fa\u65f6\u662f\u5426\u5411\u7236\u8fdb\u7a0b\u53d1\u9001SIG_CHILD\npub send_sigchld_when_exit: bool,\n}\n</code></pre> <p>\u8be5\u79cd\u8bbe\u8ba1\u7684\u4f18\u52bf\u5982\u4e0b\uff1a</p> <ul> <li>\u4fdd\u7559\u4e86 ArceOS \u7684\u7ed3\u6784\uff0c\u53ef\u4ee5\u8f83\u4e3a\u65b9\u4fbf\u5730\u4e0e\u5176\u4ed6\u540c\u5b66\u5f00\u53d1\u7ed3\u679c\u8fdb\u884c\u7ed3\u5408</li> <li>\u8026\u5408\u5ea6\u4f4e\uff0c\u56e0\u6b64\u53ef\u4ee5\u4f7f\u5185\u6838\u8f83\u4e3a\u65b9\u4fbf\u5730\u5728\u4e0d\u540c\u6a21\u5f0f\u95f4\u8fdb\u884c\u5207\u6362</li> </ul> <p>\u5728\u8be5\u79cd\u8bbe\u8ba1\u67b6\u6784\u4e0b\uff0c\u63a5\u53d7\u5916\u6765\u7cfb\u7edf\u8c03\u7528\u65f6\uff0c\u9700\u8981\u5c06\u90e8\u5206\u5bf9\u7ebf\u7a0b\u8fdb\u884c\u64cd\u4f5c\u7684\u7cfb\u7edf\u8c03\u7528\u8f6c\u53d1\u7ed9\u8fdb\u7a0b\u3002\u8fdb\u7a0b\u6536 \u5230\u8be5\u7cfb\u7edf\u8c03\u7528\u4e4b\u540e\uff0c\u518d\u5bf9\u5f53\u524d\u8fdb\u7a0b\u4e0b\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\u8fdb\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\u3002\u5b9e\u4f8b\u4e3a yield \uff0c exit \u7b49\u3002</p> <p>\u5728\u751f\u6210\u65b0\u7684\u4efb\u52a1\u65f6\uff0c\u7531\u4e8e\u662f\u901a\u8fc7Linux\u7684clone\u8c03\u7528\u751f\u6210\u65b0\u7684\u4efb\u52a1\uff0c\u56e0\u6b64\u53ef\u4ee5\u6839\u636eclone\u7684\u53c2\u6570\u5224\u65ad\u751f\u6210\u7684\u662f\u65b0\u7684\u8fdb\u7a0b\u8fd8\u662f\u7ebf\u7a0b\uff0c\u4ece\u800c\u786e\u5b9a\u7ebf\u7a0b\u6240\u5c5e\u7684\u8fdb\u7a0b\u662f\u54ea\u4e00\u4e2a\uff0c\u8fdb\u7a0b\u4e0e\u7ebf\u7a0b\u4e4b\u95f4\u5f62\u6210\u7236\u5b50\u5173\u7cfb\uff0c\u800c\u540c\u4e00\u8fdb\u7a0b\u4e0b\u7684\u7ebf\u7a0b\u5f62\u6210\u5144\u5f1f\u5173\u7cfb\uff0c\u4ece\u800c\u53ef\u4ee5\u66f4\u52a0\u65b9\u4fbf\u5730\u8fdb\u884c\u7ba1\u7406\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_3","title":"\u5730\u5740\u7a7a\u95f4\u5f15\u5165","text":""},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_4","title":"\u4efb\u52a1\u5207\u6362","text":"<p>\u5f15\u5165\u4e86\u8fdb\u7a0b\u4e4b\u540e\uff0c\u7531\u4e8e\u8fdb\u7a0b\u662f\u8d44\u6e90\u5bb9\u5668\u96c6\u5408\uff0c\u56e0\u6b64\u5730\u5740\u7a7a\u95f4\u76f8\u5173\u7684\u5b58\u50a8\u7ed3\u6784\u4e5f\u5b58\u653e\u5728\u8fd9\u91cc\uff0c\u4e0d\u540c\u8fdb\u7a0b\u4e4b\u95f4\u53ef\u4ee5\u5171\u4eab\u6216\u8005\u72ec\u4eab\u5730\u5740\u7a7a\u95f4\uff0c\u56e0\u6b64\u5728\u5207\u6362\u4efb\u52a1\u65f6\uff0c\u53ea\u9700\u8981\u989d\u5916\u5224\u65ad\u5f53\u524d\u6240\u5c5e\u8fdb\u7a0b\u7684\u5730\u5740\u7a7a\u95f4\u7684token\u662f\u5426\u53d1\u751f\u6539\u53d8\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u591a\u5730\u5740\u7a7a\u95f4\u7684\u5f15\u5165\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_5","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u76ee\u524d\u5185\u6838\u548c\u7528\u6237\u6001\u4f7f\u7528\u7684\u662f\u540c\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\uff0c\u53ef\u4ee5\u907f\u514dtrap\u65f6\u66f4\u6539\u9875\u8868\uff0c\u51cf\u5c11\u65f6\u7a7a\u635f\u8017\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_6","title":"\u7279\u6743\u7ea7\u5207\u6362","text":"<p>\u5728Starry\u4e2d\uff0c\u5404\u79cd\u6d4b\u4f8b\u8fd0\u884c\u5728\u7528\u6237\u6001\u4e0b\uff0c\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u7684\u65b9\u5f0f\u6709\u4e24\u4e2a\uff1a\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u548ctrap\u8fd4\u56de\u3002</p>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#_7","title":"\u521d\u59cb\u5316\u8fdb\u5165","text":"<p>\u5bf9\u4e8e\u7528\u6237\u7a0b\u5e8f\u521d\u59cb\u5316\u8fdb\u5165\u90e8\u5206\uff0c\u5373\u662f\u5728\u539f\u6709ArceOS\u57fa\u7840\u4e0a\u6dfb\u52a0\u4e86\u989d\u5916\u7684\u5224\u65ad\uff1a</p> <p>\u5224\u65ad\u7684\u539f\u5219\u5982\u4e0b\uff1a\u82e5\u8981\u6267\u884c\u7684\u4efb\u52a1\u7684\u5165\u53e3\u51fd\u6570\u5728\u5185\u6838\u6001\uff0c\u5219\u76f4\u63a5\u8c03\u7528\u5373\u53ef\u3002\u5426\u5219\u9700\u8981\u901a\u8fc7\u624b\u5199\u6c47\u7f16\u4ee3\u7801\u4fdd\u5b58\u5bc4\u5b58\u5668\uff0c\u4ee5\u7c7b\u4f3ctrap\u8fd4\u56de\u7684\u673a\u5236\u8c03\u7528sret\u8fdb\u5165\u7528\u6237\u6001\u6267\u884c\u5bf9\u5e94\u7684\u51fd\u6570\u3002</p> <pre><code>extern \"C\" fn task_entry() {\n// release the lock that was implicitly held across the reschedule\nunsafe { crate::RUN_QUEUE.force_unlock() };\naxhal::arch::enable_irqs();\nlet task: CurrentTask = crate::current();\nif let Some(entry) = task.entry {\nif task.get_process_id() == KERNEL_PROCESS_ID {\n// \u5bf9\u4e8eunikernel\uff0c\u8fd9\u91cc\u662f\u5e94\u7528\u7a0b\u5e8f\u7684\u5165\u53e3\uff0c\u7531\u4e8e\u90fd\u5728\u5185\u6838\u6001\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u51fd\u6570\n// \u5bf9\u4e8e\u5b8f\u5185\u6838\uff0c\u8fd9\u662f\u521d\u59cb\u8c03\u5ea6\u8fdb\u7a0b\uff0c\u4e5f\u5728\u5185\u6838\u6001\uff0c\u76f4\u63a5\u6267\u884c\u5373\u53ef\nunsafe { Box::from_raw(entry)() };\n} else {\n// \u9700\u8981\u901a\u8fc7\u5207\u6362\u7279\u6743\u7ea7\u8fdb\u5165\u5230\u5bf9\u5e94\u7684\u5e94\u7528\u7a0b\u5e8f\nlet kernel_sp = task.get_kernel_stack_top().unwrap();\n\nlet frame_address = task.get_first_trap_frame();\n// \u5207\u6362\u9875\u8868\u5df2\u7ecf\u5728switch\u5b9e\u73b0\u4e86\nfirst_into_user(kernel_sp, frame_address as usize);\n}\n}\n// only for kernel task\ncrate::exit(0);\n}\n\n/// \u521d\u59cb\u5316\u4e3b\u8fdb\u7a0b\u7684trap\u4e0a\u4e0b\u6587\n#[no_mangle]\nfn first_into_user(kernel_sp: usize, frame_base: usize) -&gt; ! {\nlet trap_frame_size = core::mem::size_of::&lt;TrapFrame&gt;();\nlet kernel_base = kernel_sp - trap_frame_size;\n// \u5728\u4fdd\u8bc1\u5c06\u5bc4\u5b58\u5668\u90fd\u5b58\u50a8\u597d\u4e4b\u540e\uff0c\u518d\u5f00\u542f\u4e2d\u65ad\n// \u5426\u5219\u6b64\u65f6\u4f1a\u56e0\u4e3a\u5199\u5165csr\u5bc4\u5b58\u5668\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e2d\u65ad\uff0c\u5bfc\u81f4\u51fa\u73b0\u5f02\u5e38\naxhal::arch::disable_irqs();\n// \u5728\u5185\u6838\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u800c\u5f53\u4ece\u5185\u6838\u6001\u8fdb\u5165\u5230\u7528\u6237\u6001\u65f6\uff0c\u4f1a\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u5148\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5373\u628a\u8be5\u4efb\u52a1\u5bf9\u5e94\u7684CPU ID\u5b58\u50a8\u5728\u5185\u6838\u6808\u4e0a\n// \u7136\u540e\u5c06tp\u5bc4\u5b58\u5668\u7684\u503c\u6539\u4e3a\u5bf9\u5e94\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u56e0\u6b64\u5728\u7528\u6237\u6001\u4e2d\uff0ctp\u5bc4\u5b58\u5668\u5b58\u50a8\u7684\u503c\u662f\u7ebf\u7a0b\u7684tls\u6307\u9488\u7684\u503c\n// \u800c\u5f53\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\u65f6\uff0c\u4f1a\u5148\u5c06\u5185\u6838\u6808\u4e0a\u7684\u503c\u8bfb\u53d6\u5230\u67d0\u4e00\u4e2a\u4e2d\u95f4\u5bc4\u5b58\u5668t0\u4e2d\uff0c\u7136\u540e\u5c06tp\u7684\u503c\u5b58\u5165\u5185\u6838\u6808\n// \u7136\u540e\u518d\u5c06t0\u7684\u503c\u8d4b\u7ed9tp\uff0c\u56e0\u6b64\u6b64\u65f6tp\u7684\u503c\u662f\u5f53\u524d\u4efb\u52a1\u7684CPU ID\n// \u5bf9\u5e94\u5b9e\u73b0\u5728axhal/src/arch/riscv/trap.S\u4e2d\nunsafe {\nasm::sfence_vma_all();\ncore::arch::asm!(\nr\"\n            mv      sp, {frame_base}\n            .short  0x2432                      // fld fs0,264(sp)\n            .short  0x24d2                      // fld fs1,272(sp)\n            LDR     gp, sp, 2                   // load user gp and tp\n            LDR     t0, sp, 3\n            mv      t1, {kernel_base}\n            STR     tp, t1, 3                   // save supervisor tp\uff0c\u6ce8\u610f\u662f\u5b58\u50a8\u5230\u5185\u6838\u6808\u4e0a\u800c\u4e0d\u662fsp\u4e2d\uff0c\u6b64\u65f6\u5b58\u50a8\u7684\u5e94\u8be5\u662f\u5f53\u524d\u8fd0\u884c\u7684CPU\u7684ID\n            mv      tp, t0                      // tp\uff1a\u672c\u6765\u5b58\u50a8\u7684\u662fCPU ID\uff0c\u5728\u8fd9\u4e2a\u65f6\u5019\u53d8\u6210\u4e86\u5bf9\u5e94\u7ebf\u7a0b\u7684TLS \u6307\u9488\n            csrw    sscratch, {kernel_sp}       // put supervisor sp to scratch\n            LDR     t0, sp, 31\n            LDR     t1, sp, 32\n            csrw    sepc, t0\n            csrw    sstatus, t1\n            POP_GENERAL_REGS\n            LDR     sp, sp, 1\n            sret\n        \",\nframe_base = in(reg) frame_base,\nkernel_sp = in(reg) kernel_sp,\nkernel_base = in(reg) kernel_base,\n);\n};\ncore::panic!(\"already in user mode!\")\n}\n</code></pre>"},{"location":"3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/3.%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/#trap","title":"trap\u5207\u6362","text":"<p>trap\u5207\u6362\u5bf9\u5e94\u7684\u6c47\u7f16\u4ee3\u7801\u5728<code>axhal/src/arch/riscv</code>\uff0c\u503c\u5f97\u5173\u6ce8\u7684\u662f\u5176\u5d4c\u5957trap\u7684\u5904\u7406\u3002\u5728\u7b2c\u4e00\u6b21\u8fdb\u5165trap\u65f6\uff0c\u662f\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5230\u5185\u6838\u6001\uff0c\u6b64\u65f6\u4f1a\u5c06\u5185\u6838\u6808\u7684\u5730\u5740\u8d4b\u7ed9sp\uff0c\u5c06\u7528\u6237\u6808\u7684\u5730\u5740\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u5e76\u5c06sscratch\u6e05\u96f6\u3002\u82e5\u53d1\u751f\u5185\u6838\u5d4c\u5957trap\uff0c\u5219\u6b64\u65f6sscratch\u7684\u503c\u4e3a0\uff0c\u4e0esp\u4ea4\u6362\u4e4b\u540e\uff0csp\u4e3a0\uff0c\u5373\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p> <p>\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u4ea4\u6362\u4e4b\u540esp\u662f\u5426\u4e3a0\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u5185\u6838\u5d4c\u5957trap\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.10%E5%AE%8F%E5%86%85%E6%A0%B8%E7%94%A8%E6%88%B7%E5%BA%93-starry/","title":"4.10 \u5b8f\u5185\u6838\u7528\u6237\u5e93-starry","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.10%E5%AE%8F%E5%86%85%E6%A0%B8%E7%94%A8%E6%88%B7%E5%BA%93-starry/#-starry","title":"\u5b8f\u5185\u6838\u7528\u6237\u5e93--starry","text":"<p>\u6839\u636estarry\u7684\u6a21\u5757\u5316\u8bbe\u8ba1\u601d\u8def\uff0c\u7528\u6237\u5e93\u662f\u5728\u7ed9\u5b9a\u6a21\u5757\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u7edf\u5408\u3001\u63d0\u4f9b\u5bf9\u5916\u7edf\u4e00\u63a5\u53e3\u7684\u4ee3\u7801\u90e8\u5206\u3002\u800c\u5b8f\u5185\u6838\u67b6\u6784\u4e0b\u5bf9\u5916\u63d0\u4f9b\u7684\u63a5\u53e3\u4ee5Linux\u7684\u7cfb\u7edf\u8c03\u7528\u5f62\u5f0f\u8fdb\u884c\u5448\u73b0\u3002\u56e0\u6b64starry_libax\u90e8\u5206\u4e3b\u8981\u4fbf\u662f\u5bf9\u7cfb\u7edf\u8c03\u7528\u7684\u5c01\u88c5\u5b9e\u73b0\u4ee5\u53ca\u6279\u91cf\u6d4b\u8bd5\u7684\u5b9e\u73b0\u3002</p> <p></p> <p>\u5404\u90e8\u5206\u7684\u989d\u5916\u8865\u5145\u8bf4\u660e\u5982\u4e0b</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.10%E5%AE%8F%E5%86%85%E6%A0%B8%E7%94%A8%E6%88%B7%E5%BA%93-starry/#syscall","title":"syscall","text":"<p>\u5173\u4e8esyscall\u6a21\u5757\u5404\u81ea\u6587\u4ef6\u529f\u80fd\u989d\u5916\u8bf4\u660e\u5982\u4e0b\uff1a</p> <ul> <li> <p>epoll\uff1a\u5b9e\u73b0poll\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u7684\u529f\u80fd\uff0c\u5982epoll/ppoll/poll\u7b49\u7cfb\u7edf\u8c03\u7528\uff0c\u501f\u9274\u4e8ematurin/modules/epoll at master \u00b7 scPointer/maturin (github.com)</p> </li> <li> <p>futex\uff1a\u5b9e\u73b0\u4efb\u52a1\u4e92\u65a5\u9501\u90e8\u5206\uff0c\u5b83\u662f\u7528\u6237\u6001\u591a\u4efb\u52a1\u534f\u540c\u5f00\u53d1\u7684\u91cd\u70b9\uff0c\u56e0\u6b64\u9700\u8981\u8c28\u614e\u8003\u8651\u5176\u5b9e\u73b0\u3002</p> </li> </ul> <p>futex\u7684\u539f\u7406\u662f\u4ee5\u4e00\u4e2a\u6307\u5b9a\u7684\u53d8\u91cf\u4f5c\u4e3afutex\u53d8\u91cf\uff0c\u591a\u4e2a\u4efb\u52a1\u5728\u7b49\u5f85\u83b7\u53d6\u8fd9\u4e2a\u53d8\u91cf\u7684\u6267\u884c\u6743\u9650\u3002\u4f46\u662f\u5426\u4f1a\u51fa\u73b0\u591a\u4efb\u52a1\u540c\u65f6\u64cd\u4f5c\u540c\u4e00\u4e2a\u53d8\u91cf\u7684\u51b2\u7a81\u95ee\u9898\u4e0d\u7531\u5185\u6838\u8003\u8651\uff0c\u800c\u662f\u7531\u7528\u6237\u81ea\u884c\u8003\u8651\u5e76\u4e14\u5b9e\u73b0\uff0c\u800c\u5185\u6838\u53ea\u9700\u8981\u5b9e\u73b0futex\u76f8\u5173\u7684\u64cd\u4f5c\u5bf9\u5e94\u7684\u8bed\u4e49\u5373\u53ef\u3002</p> <p>\u5173\u4e8efutex\u7684\u6838\u5fc3\u64cd\u4f5c\u6709\u4e24\u4e2a\uff1await\u548cwake\u3002\u4ee5\u4e0b\u5206\u522b\u4ecb\u7ecd\u8fd9\u4e24\u79cd\u64cd\u4f5c\u7684\u5904\u7406\u65b9\u5f0f\uff1a</p> <ul> <li>wait\uff1a\u5f53\u4e00\u4e2a\u4efb\u52a1\u8c03\u7528futex\u7684wait\u64cd\u4f5c\u65f6\uff0c\u4f1a\u6307\u5b9a\u4e00\u4e2afutex\u53d8\u91cf\u7684\u5730\u5740\uff0c\u6b64\u65f6\u4ee3\u8868\u7740\u8fd9\u4e2a\u4efb\u52a1\u9700\u8981\u7b49\u5f85\u8be5futex\u7684\u6743\u9650\u3002\u90a3\u4e48\u8fd9\u4e2a\u4efb\u52a1\u4f1a\u88ab\u52a0\u5165\u5230\u8be5futex\u53d8\u91cf\u7684\u7b49\u5f85\u5e8f\u5217\u4e4b\u4e2d\u3002\u4e4b\u540e\u4efb\u52a1\u4f1a\u6309\u7167\u6307\u5b9a\u7684\u4f11\u7720\u65f6\u95f4\u8fdb\u884c\u4f11\u7720\uff0c\u76f4\u5230\u88ab\u5524\u9192\u3002</li> <li>wake\uff1a\u5f53\u67d0\u4e00\u4e2a\u4efb\u52a1\u5b8c\u6210\u4e86\u5bf9\u67d0\u4e00\u4e2afutex\u53d8\u91cf\u7684\u64cd\u4f5c\u4e4b\u540e\uff0c\u4f1a\u8c03\u7528futex\u7684wake\u64cd\u4f5c\uff0c\u6b64\u65f6\u4ee3\u8868\u7740\u91ca\u653e\u4e86\u8be5futex\u53d8\u91cf\u3002\u5185\u6838\u9700\u8981\u4ece\u8be5futex\u53d8\u91cf\u7684\u7b49\u5f85\u5e8f\u5217\u4e2d\u627e\u5230\u4e00\u4e2a\u4ecd\u7136\u5728\u4f11\u7720\u7684\u4efb\u52a1\uff0c\u5e76\u4e14\u624b\u52a8\u5524\u9192\u5b83\uff0c\u63a5\u7ba1futex\u53d8\u91cf\u7684\u6743\u9650\u3002</li> </ul> <p>\u5f53\u4e00\u4e2a\u4efb\u52a1wait for\u4e00\u4e2afutex\u53d8\u91cf\u65f6\uff0c\u5176\u88ab\u5524\u9192\u7684\u65b9\u5f0f\u6709\u4e09\u79cd\uff1a</p> <ol> <li>\u539f\u6709\u7684futex\u53d8\u91cf\u88ab\u91ca\u653e\uff0c\u8be5\u4efb\u52a1\u83b7\u5f97\u4e86\u63a7\u5236\u6743</li> <li>\u4efb\u52a1\u4f11\u7720\u65f6\u95f4\u5230\u671f</li> <li>\u539f\u6709futex\u53d8\u91cf\u5730\u5740\u4e0a\u5b58\u50a8\u7684\u503c\u88ab\u6539\u53d8</li> </ol> <p>\u4f9d\u636e\u4e0a\u8ff0\u4e09\u79cd\u60c5\u51b5\uff0c\u5373\u53ef\u5b9e\u73b0futex\u7cfb\u7edf\u8c03\u7528\u7684\u76f8\u5173\u5904\u7406\u65b9\u5f0f\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.10%E5%AE%8F%E5%86%85%E6%A0%B8%E7%94%A8%E6%88%B7%E5%BA%93-starry/#fs","title":"fs","text":"<p>fs\u6a21\u5757\u662f\u4e3a\u4e86\u652f\u6301\u6587\u4ef6\u76f8\u5173\u7684\u7cfb\u7edf\u8c03\u7528\u800c\u5b9e\u73b0\u7684\u529f\u80fd\uff0c\u5305\u62ec\u6587\u4ef6\u63cf\u8ff0\u7b26\u3001\u94fe\u63a5\u3001\u6302\u8f7d\u7b49\u529f\u80fd\u3002\u4e4b\u6240\u4ee5\u5c06\u8be5\u6a21\u5757\u653e\u5728\u8fd9\u4e2a\u90e8\u5206\u800c\u4e0d\u662f\u653e\u5728axprocess\u6216\u8005axfs\u4e2d\uff0c\u662f\u56e0\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u5185\u5bb9\u662f\u4e0eLinux\u7cfb\u7edf\u8c03\u7528\u8026\u5408\u5ea6\u8f83\u9ad8\u7684\u5185\u5bb9\uff0c\u662f\u7cfb\u7edf\u8c03\u7528\u7684\u7279\u5b9a\u8bbe\u7f6e\uff0c\u5728\u5176\u4ed6\u5982\u5fae\u5185\u6838\u7684\u67b6\u6784\u4e2d\u4e5f\u5b58\u5728\u7740\u7c7b\u4f3c\u6587\u4ef6\u7cfb\u7edf\u7684\u529f\u80fd\uff0c\u4f46\u4e0d\u4e00\u5b9a\u8981\u5177\u5316\u5230\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u56e0\u6b64axfs\u4e2d\u5b58\u653e\u7684\u662f\u6587\u4ef6\u7cfb\u7edf\u7684\u7edf\u4e00\u5b9e\u73b0\uff0c\u800c\u5982\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u8f83\u8d34\u8fd1Linux\u7684\u5185\u5bb9\u5219\u653e\u5728Linux\u517c\u5bb9\u5c42\u7528\u6237\u5e93starry_libax\u4e2d\u5b9e\u73b0\uff0c\u4ece\u800c\u66f4\u52a0\u8d34\u8fd1\u6a21\u5757\u5316\u5185\u6838\u7684\u8bbe\u8ba1\u601d\u8def\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.1%E5%86%85%E6%A0%B8%E5%BA%95%E5%B1%82%E6%A8%A1%E5%9D%97-axhal/","title":"4.1 \u5185\u6838\u5e95\u5c42\u6a21\u5757-axhal","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.1%E5%86%85%E6%A0%B8%E5%BA%95%E5%B1%82%E6%A8%A1%E5%9D%97-axhal/#-axhal","title":"\u5185\u6838\u5e95\u5c42\u6a21\u5757--axhal","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.2%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97-axdriver/","title":"4.2 \u8bbe\u5907\u9a71\u52a8\u6a21\u5757-axdriver","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.2%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9D%97-axdriver/#-axdriver","title":"\u8bbe\u5907\u9a71\u52a8\u6a21\u5757--axdriver","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.3%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97-axmem/","title":"4.3 \u5185\u5b58\u7ba1\u7406\u6a21\u5757-axmem","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.3%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97-axmem/#-axmem","title":"\u5185\u5b58\u7ba1\u7406\u6a21\u5757--axmem","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.4%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9D%97-axnet/","title":"4.4 \u7f51\u7edc\u6a21\u5757-axnet","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.4%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9D%97-axnet/#-axnet","title":"\u7f51\u7edc\u6a21\u5757--axnet","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.5%E4%BF%A1%E5%8F%B7%E6%A8%A1%E5%9D%97-axsignal/","title":"4.5 \u4fe1\u53f7\u6a21\u5757-axsignal","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.5%E4%BF%A1%E5%8F%B7%E6%A8%A1%E5%9D%97-axsignal/#-axsignal","title":"\u4fe1\u53f7\u6a21\u5757--axsignal","text":"<p>axsignal\u662fstarry\u7684\u4fe1\u53f7\u6a21\u5757\uff0c\u8d1f\u8d23\u5b9e\u73b0\u8fdb\u7a0b\u95f4\u3001\u4efb\u52a1\u95f4\u7b49\u901a\u4fe1\u673a\u5236\u3002\u5f53\u524d\u5b9e\u73b0\u7684\u539f\u7406\u4e3b\u8981\u501f\u9274\u4e8eLinux\u7684\u4fe1\u53f7\u673a\u5236\u3002\u76f8\u5173\u529f\u80fd\u5212\u5206\u5982\u4e0b\uff1a</p> <p></p> <p>\u5176\u4e2d\u5404\u90e8\u5206\u7684\u989d\u5916\u8865\u5145\u8bf4\u660e\u5982\u4e0b\uff1a</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.5%E4%BF%A1%E5%8F%B7%E6%A8%A1%E5%9D%97-axsignal/#action","title":"action","text":"<p>action.rs\u6307\u5b9a\u4e86\u5904\u7406\u67d0\u4e00\u4fe1\u53f7\u65f6\u7684\u5177\u4f53\u64cd\u4f5c\u65b9\u5f0f\u3002\u64cd\u4f5c\u65b9\u5f0f\u7684\u6307\u5b9a\u662f\u901a\u8fc7\u5b9a\u4e49<code>SigAction</code>\u7ed3\u6784\u4f53\u5b9e\u73b0\u7684\uff0c\u76f8\u5173\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>pub struct SigAction {\n/// \u4fe1\u53f7\u5904\u7406\u51fd\u6570\u7684\u5730\u5740\n/// 1. \u5982\u679c\u662f\u4e0a\u8ff0\u7279\u6b8a\u503c SIG_DFL \u6216 SIG_IGN\uff0c\u5219\u6309\u63cf\u8ff0\u5904\u7406\n/// 2. \u82e5flags\u6ca1\u6709\u6307\u5b9aSA_SIGINFO\uff0c\u5219\u51fd\u6570\u539f\u578b\u4e3a fn(sig: SignalNo) -&gt; ()\uff0c\u5bf9\u5e94C\u8bed\u8a00\u539f\u578b\u4e3a void (*sa_handler)(int)\n/// 3. \u82e5flags\u6307\u5b9a\u4e86SA_SIGINFO\uff0c\u5219\u51fd\u6570\u539f\u578b\u4e3a fn(sig: SignalNo, info: &amp;SigInfo, ucontext: &amp;mut UContext) -&gt; ()\uff0c\n/// \u5bf9\u5e94C\u8bed\u8a00\u539f\u578b\u4e3a void (*sa_sigaction)(int, siginfo_t *, void *)\u3002\n///\n/// \u5176\u4e2d\uff0cSigInfo\u548cSignalNo\u7684\u5b9a\u4e49\u89c1siginfo.rs\u548csignal_no.rs\u3002\n/// UContext\u5373\u662f\u5904\u7406\u4fe1\u53f7\u65f6\u5185\u6838\u4fdd\u5b58\u7684\u7528\u6237\u6001\u4e0a\u4e0b\u6587\uff0c\u5b83\u5b58\u50a8\u5728\u7528\u6237\u5730\u5740\u7a7a\u95f4\uff0c\u4f1a\u5728\u8c03\u7528sig_return\u65f6\u88ab\u6062\u590d\uff0c\u5b9a\u4e49\u89c1ucontext.rs\u3002\npub sa_handler: usize,\n/// \u4fe1\u53f7\u5904\u7406\u7684flags\npub sa_flags: SigActionFlags,\n/// \u4fe1\u53f7\u5904\u7406\u7684\u8df3\u677f\u9875\u5730\u5740\uff0c\u5b58\u50a8\u4e86sig_return\u7684\u51fd\u6570\u5904\u7406\u5730\u5740\n/// \u4ec5\u5728SA_RESTORER\u6807\u5fd7\u88ab\u8bbe\u7f6e\u65f6\u6709\u6548\npub restorer: usize,\n/// \u8be5\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u7684\u4fe1\u53f7\u63a9\u7801\npub sa_mask: usize,\n}\n</code></pre> <p>\u5176\u4e2d\u503c\u5f97\u8bf4\u660e\u7684\u662f<code>restorer</code>\u3002\u60f3\u8981\u4e86\u89e3\u8fd9\u4e2a<code>restorer</code>\u5c31\u9700\u8981\u4e86\u89e3Linux\u89c4\u5b9a\u7684\u4fe1\u53f7\u5904\u7406\u673a\u5236\u6d41\u7a0b\uff1a</p> <p></p> <p>\u4e0a\u56fe\u5f15\u7528\u81earCore\u6559\u5b66\u6587\u6863\u4fe1\u53f7 - rCore-Tutorial-Book-v3 3.6.0-alpha.1 \u6587\u6863 (rcore-os.cn)</p> <p>\u6839\u636e\u4e0a\u56fe\u53ef\u77e5\uff0c\u5f53\u8fdb\u5165\u4fe1\u53f7\u5904\u7406\u9636\u6bb5\u4e4b\u540e\uff0c\u82e5\u6307\u5b9a\u4e86\u4fe1\u53f7\u5904\u7406\u4f8b\u7a0b\uff0c\u90a3\u4e48\u5185\u6838\u4f1a\u8fd4\u56de\u7528\u6237\u6001\uff0c\u8df3\u8f6c\u5230\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u5bf9\u5e94\u5165\u53e3\u8fdb\u884c\u4fe1\u53f7\u5904\u7406\u3002</p> <p>\u4f20\u7edf\u7684C\u8bed\u8a00\u51fd\u6570\u4e2d\uff0c\u51fd\u6570\u6267\u884c\u7ed3\u675f\u65f6\uff0c\u5185\u6838\u4f1a\u5c06ra\u5bc4\u5b58\u5668\u7684\u503c\u8d4b\u7ed9pc\uff0c\u5373pc\u8df3\u8f6c\u5230ra\u6307\u5b9a\u7684\u5730\u5740\u4e0a\u3002</p> <p>\u800c\u5bf9\u4e8e\u4fe1\u53f7\u5904\u7406\u51fd\u6570\uff0c\u81ea\u7136\u4e5f\u9700\u8981\u4e00\u4e2a\u8fd4\u56de\u5730\u5740\uff0c\u5373\u6211\u4eec\u521a\u624d\u63d0\u5230\u7684<code>restorer</code>\u5b57\u6bb5\u3002</p> <p>\u5f53\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\uff0c\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ol> <li>\u7528\u6237\u624b\u52a8\u6307\u5b9a\u4e86\u8fd4\u56de\u5730\u5740<code>restorer</code>\uff1a\u6b64\u65f6\u7531\u4e8e\u6211\u4eec\u7684\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u7f16\u8bd1\u4e4b\u540e\uff0c\u4f1a\u5728\u7ed3\u675f\u65f6\u81ea\u52a8\u8df3\u8f6c\u5230ra\u4e0a\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u5728\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u5f00\u59cb\u524d\uff0c\u5c06<code>restorer</code>\u5b57\u6bb5\u8d4b\u7ed9ra\u5bc4\u5b58\u5668\u5373\u53ef\u3002\u4e4b\u540e\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u4e4b\u540e\u5c31\u4f1a\u8df3\u8f6c\u5230\u6307\u5b9a\u5730\u5740\u3002</li> <li>\u7528\u6237\u672a\u624b\u52a8\u8c03\u7528\u8fd4\u56de\u5730\u5740<code>restorer</code>\uff1a\u6b64\u65f6\u5185\u6838\u9700\u8981\u624b\u52a8\u5e2e\u52a9\u7528\u6237\u6267\u884c<code>sig_return</code>\u7cfb\u7edf\u8c03\u7528\uff0c\u5176\u529f\u80fd\u662f\u544a\u77e5\u5185\u6838\u4fe1\u53f7\u5df2\u7ecf\u5904\u7406\u5b8c\u6bd5\uff0c\u65b9\u4fbf\u5185\u6838\u6062\u590d\u56e0\u4e3a\u5904\u7406\u4fe1\u53f7\u800c\u88ab\u6253\u65ad\u7684trap\u4e0a\u4e0b\u6587\u3002\u800c\u624b\u52a8\u5904\u7406\u7684\u65b9\u5f0f\u5373\u662f\u5c06<code>restorer</code>\u5b57\u6bb5\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u975e\u6cd5\u7684\u7279\u6b8a\u5b57\u6bb5\uff1a<code>SIGNAL_RETURN_TRAP</code>\u3002\u5f53\u7528\u6237\u6001\u4e0b\u7684\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u65f6\uff0c\u5b83\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230ra\u5bc4\u5b58\u5668\u6307\u5b9a\u7684\u5730\u5740\uff0c\u5373\u8df3\u8f6c\u5230<code>SIGNAL_RETURN_TRAP</code>\uff0c\u4ece\u800c\u89e6\u53d1<code>InstructionPageFault</code>\u3002\u6b64\u65f6\u5185\u6838\u6355\u83b7\u5230trap\u4e4b\u540e\uff0c\u5c31\u53ef\u4ee5\u6839\u636e\u89e6\u53d1page fault\u7684\u5730\u5740\u5224\u65ad\u662f\u5426\u89e6\u53d1\u4e86<code>sig_return</code>\u3002\u82e5\u662f\uff0c\u5219\u624b\u52a8\u8c03\u7528<code>sig_return</code>\u7cfb\u7edf\u8c03\u7528\u5373\u53ef\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u901a\u8fc7\u5bf9<code>restorer</code>\u7684\u5408\u7406\u4f7f\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u6bd4\u8f83\u5de7\u5999\u5730\u5b9e\u73b0\u4fe1\u53f7\u5904\u7406\u7684\u8fd4\u56de\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97-axtask/","title":"4.6 \u4efb\u52a1\u8c03\u5ea6\u6a21\u5757-axtask","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97-axtask/#-axtask","title":"\u4efb\u52a1\u8c03\u5ea6\u6a21\u5757--axtask","text":"<p>\u4efb\u52a1\u8c03\u5ea6\u662f\u5185\u6838\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u73af\u8282\u3002\u4e3a\u4e86\u4fdd\u8bc1\u548c\u4e0a\u6e38arceos\u4ed3\u5e93\u8f83\u597d\u7684\u8fdb\u884c\u5339\u914d\uff0c\u56e0\u6b64starry\u7684\u4efb\u52a1\u8c03\u5ea6\u673a\u5236\u57fa\u672c\u53c2\u7167\u4e86arceos\u7684\u8c03\u5ea6\u673a\u5236\uff0c\u5e76\u5728\u6b64\u57fa\u7840\u4e0a\u8fdb\u884c\u4e86\u9002\u914d\u5b8f\u5185\u6838\u7684\u8c03\u6574\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u5b8f\u5185\u6838\u67b6\u6784\u4f53\u7cfb\uff0c\u9700\u8981\u5bf9\u539f\u6709Arceos\u7684\u90e8\u5206\u6838\u5fc3\u6a21\u5757\uff08\u5982axtask\uff09\u8fdb\u884c\u4fee\u6539\u3002\u4e3a\u4e86\u9632\u6b62\u5408\u5e76\u65f6\u51b2\u7a81\u8fc7\u591a\uff0c\u56e0\u6b64\u5728\u5bf9\u5e94\u6a21\u5757\u4e0b\u5efa\u7acb<code>monolithic_task</code>\u6587\u4ef6\u5939\uff0c\u5b58\u653e\u4e3a\u5b8f\u5185\u6838\u67b6\u6784\u5b9e\u73b0\u7684\u5185\u5bb9\u3002\u540c\u65f6\u4f7f\u7528\u6761\u4ef6\u7f16\u8bd1\u6765\u9009\u62e9\u662f\u5b8f\u5185\u6838\u67b6\u6784\u8fd8\u662funikernel\u67b6\u6784\u3002</p> <p>\u4ee5\u4e0b\u4e3aStarry\u5b9e\u73b0\u7684\u4efb\u52a1\u8c03\u5ea6\u6a21\u5757\u7684\u76f8\u5173\u529f\u80fd\u5212\u5206\uff1a</p> <p></p> <p>\u5bf9\u529f\u80fd\u7684\u989d\u5916\u8865\u5145\u8bf4\u660e\u5982\u4e0b\uff1a</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97-axtask/#task","title":"task","text":"<p>\u4efb\u52a1\u5355\u5143\u662f\u5185\u6838\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u7ec4\u6210\u90e8\u5206\uff0c\u4efb\u52a1\u8c03\u5ea6\u6a21\u5757\u7684\u7ec4\u6210\u5982\u4e0b\uff1a</p> <pre><code>pub struct TaskInner {\nid: TaskId,\nname: String,\nis_idle: bool,\nis_init: bool,\n\nentry: Option&lt;*mut dyn FnOnce()&gt;,\nstate: AtomicU8,\n\nin_wait_queue: AtomicBool,\n#[cfg(feature = \"irq\")]\nin_timer_list: AtomicBool,\n\n#[cfg(feature = \"preempt\")]\nneed_resched: AtomicBool,\n#[cfg(feature = \"preempt\")]\npub preempt_disable_count: AtomicUsize,\n\nexit_code: AtomicI32,\nwait_for_exit: WaitQueue,\n\n#[cfg(feature = \"monolithic\")]\nkstack: Option&lt;TaskStack&gt;,\n\nctx: UnsafeCell&lt;TaskContext&gt;,\n\n#[cfg(feature = \"monolithic\")]\n// \u5bf9\u5e94\u8fdb\u7a0bID\nprocess_id: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u662f\u5426\u662f\u6240\u5c5e\u8fdb\u7a0b\u4e0b\u7684\u4e3b\u7ebf\u7a0b\nis_leader: AtomicBool,\n\n#[cfg(feature = \"monolithic\")]\n// \u6240\u5c5e\u9875\u8868ID\uff0c\u5728\u5b8f\u5185\u6838\u4e0b\u9ed8\u8ba4\u4f1a\u5f00\u542f\u5206\u9875\uff0c\u662f\u53ea\u8bfb\u7684\u6240\u4ee5\u4e0d\u7528\u539f\u5b50\u91cf\npage_table_token: usize,\n\n#[cfg(feature = \"monolithic\")]\n/// \u521d\u59cb\u5316\u7684trap\u4e0a\u4e0b\u6587\npub trap_frame: UnsafeCell&lt;TrapFrame&gt;,\n\n// \u65f6\u95f4\u7edf\u8ba1\n#[cfg(feature = \"monolithic\")]\ntime: UnsafeCell&lt;TimeStat&gt;,\n\n#[allow(unused)]\n#[cfg(feature = \"monolithic\")]\n/// \u5b50\u7ebf\u7a0b\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u5b58\u653etid\u7684\u5730\u5740\nset_child_tid: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u5b50\u7ebf\u7a0b\u521d\u59cb\u5316\u65f6\uff0c\u5c06\u8fd9\u4e2a\u5730\u5740\u6e05\u7a7a\uff1b\u5b50\u7ebf\u7a0b\u9000\u51fa\u65f6\uff0c\u89e6\u53d1\u8fd9\u91cc\u7684 futex\u3002\n/// \u5728\u521b\u5efa\u65f6\u5305\u542b CLONE_CHILD_SETTID \u65f6\u624d\u975e0\uff0c\u4f46\u53ef\u4ee5\u88ab sys_set_tid_address \u4fee\u6539\nclear_child_tid: AtomicU64,\n\n#[cfg(feature = \"monolithic\")]\n/// \u9000\u51fa\u65f6\u662f\u5426\u5411\u7236\u8fdb\u7a0b\u53d1\u9001SIG_CHILD\npub send_sigchld_when_exit: Bool,\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\uff0c\u4efb\u52a1\u7ed3\u6784\u4f53\u4e2d\u7684\u67d0\u4e9b\u5b57\u6bb5\u5305\u542b\u7740\u591a\u6838\u5b89\u5168\u6027\uff0c\u56e0\u4e3a\u867d\u7136\u4e00\u4e2a\u4efb\u52a1\u4ec5\u4f1a\u5728\u4e00\u4e2aCPU\u6838\u4e0a\u8fd0\u884c\uff0c\u4f46\u662f\u4e0d\u540cCPU\u53ef\u80fd\u4f1a\u540c\u65f6\u8bbf\u95ee\u540c\u4e00\u4e2a\u4efb\u52a1\u7684\u67d0\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5bfc\u81f4\u51fa\u73b0\u591a\u6838\u51b2\u7a81\uff0c\u56e0\u6b64\u9700\u8981\u4e3a\u5bf9\u5e94\u5b57\u6bb5\u52a0\u4e0a\u539f\u5b50\u6027\u3002</p> <p>\u53e6\u5916\uff0ctask\u5b57\u6bb5\u4e5f\u63d0\u4f9b\u4e86\u67d0\u4e00\u4e2a\u4efb\u52a1\u7b2c\u4e00\u6b21\u6267\u884c\u7684\u5b9e\u73b0\u3002\u5b83\u9700\u8981\u6839\u636e\u662f\u5426\u4e3a\u5b8f\u5185\u6838\u67b6\u6784\u5206\u522b\u8fdb\u884c\u5b9e\u73b0\u3002</p> <ul> <li>Arceos\u5b9e\u73b0\uff1a\u5728Arceos\u4e0b\uff0c\u4ee3\u7801\u59cb\u7ec8\u5728\u5185\u6838\u6001\u4e0b\u8fd0\u884c\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u8df3\u8f6c\u5230\u4efb\u52a1\u5165\u53e3\u51fd\u6570\u6267\u884c\u3002\u56e0\u6b64\u4f1a\u628a\u5165\u53e3\u51fd\u6570\u7684\u5730\u5740\u76f4\u63a5\u8bb0\u5f55\u5728task\u7684entry\u5b57\u6bb5\u4e0a\uff0c\u5e76\u4e14\u5728\u7b2c\u4e00\u6b21\u6267\u884c\u4efb\u52a1\u65f6\u76f4\u63a5\u8df3\u8f6c\u5230entry\u5b57\u6bb5\u7684\u5730\u5740\u5373\u53ef\u3002</li> <li>Starry\u5b9e\u73b0\uff1a\u5728Starry\u4e0b\uff0c\u4efb\u52a1\u4f1a\u8fdb\u5165\u5230\u7528\u6237\u6001\u8fd0\u884c\uff0c\u6b64\u65f6\u9700\u8981\u628a\u4efb\u52a1\u521d\u59cb\u5316\u7684trap\u4e0a\u4e0b\u6587\u653e\u7f6e\u5230\u5185\u6838\u6808\u4e0a\uff0c\u5e76\u4e14\u8fdb\u884csret\u8df3\u8f6c\u3002</li> </ul>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97-axtask/#run_queue","title":"run_queue","text":"<p>\u4efb\u52a1\u8c03\u5ea6\u662f\u4efb\u52a1\u6a21\u5757\u5b9e\u73b0\u7684\u91cd\u70b9\u3002\u63a5\u4e0b\u6765\u7b80\u8981\u4ecb\u7ecd\u4ee5\u4e0bstarry\u7684\u4efb\u52a1\u542f\u52a8\u548c\u8c03\u5ea6\u6d41\u7a0b\u3002</p> <p>\u5f53\u524d\u4efb\u52a1\u8c03\u5ea6\u673a\u5236\u662ffifo\u961f\u5217\u6cd5\uff0c\u542f\u52a8\u548c\u8c03\u5ea6\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ul> <li>\u5355\u6838\u60c5\u51b5</li> </ul> <p>\u5bf9\u5e94\u4ee3\u7801\u5728<code>modules/axtask/src/monolithic_task/run_queue.rs/init</code>\u51fd\u6570\u4e2d\uff1a</p> <pre><code>pub(crate) fn init() {\nconst IDLE_TASK_STACK_SIZE: usize = 0x20000;\nlet idle_task = TaskInner::new(\n|| crate::run_idle(),\n\"idle\".into(),\nIDLE_TASK_STACK_SIZE,\nKERNEL_PROCESS_ID,\n0,\nfalse,\n);\nIDLE_TASK.with_current(|i: &amp;mut LazyInit&lt;Arc&lt;scheduler::FifoTask&lt;TaskInner&gt;&gt;&gt;| {\ni.init_by(idle_task.clone())\n});\n\nlet main_task = TaskInner::new_init(\"main\".into());\nmain_task.set_state(TaskState::Running);\n\nRUN_QUEUE.init_by(AxRunQueue::new());\nunsafe { CurrentTask::init_current(main_task) }\n}\n</code></pre> <p>\u5171\u5305\u542b\u4e09\u4e2a\u4efb\u52a1\uff1a</p> <ul> <li> <p>idle_task\uff1a\u62e5\u6709\u72ec\u7acb\u7684trap\u4e0a\u4e0b\u6587\u548c\u4efb\u52a1\u4e0a\u4e0b\u6587\uff0c\u4efb\u52a1\u4e0a\u4e0b\u6587\u6307\u5411\u7684\u5165\u53e3\u662f<code>run_idle</code>\u51fd\u6570\u3002</p> </li> <li> <p>gc_task\uff1a\u5728\u6267\u884c<code>AxRunQueue::new()</code>\u51fd\u6570\u65f6\u751f\u6210\uff0c\u8d1f\u8d23\u56de\u6536\u5df2\u7ecf\u9000\u51fa\u7684\u4efb\u52a1\u3002</p> </li> <li> <p>main_task\uff1a\u5185\u6838\u8fd0\u884c\u65f6\u6267\u884c\u7684\u4efb\u52a1\uff0c\u5b83\u7684\u4efb\u52a1\u4e0a\u4e0b\u6587\u4e3a\u7a7a\uff0c\u5728\u88ab\u5207\u6362\u65f6\u4f1a\u628a\u5f53\u524d\u7684ra\u7b49\u4fe1\u606f\u5199\u5165\u4efb\u52a1\u4e0a\u4e0b\u6587\uff0c\u4ece\u800c\u53ef\u4ee5\u5728\u6062\u590d\u65f6\u7ee7\u7eed\u6267\u884c\u5185\u6838\u76f8\u5173\u4ee3\u7801\u3002</p> </li> </ul> <p>\u5f53\u6267\u884c\u5b8cinit\u51fd\u6570\u4e4b\u540e\uff0cCPU\u6307\u5411main_task\uff0cpc\u4e0d\u53d8\uff0c\u7ee7\u7eed\u6267\u884c\u5f53\u524d\u4ee3\u7801\uff0c\u76f4\u5230\u6765\u5230<code>modules/axruntime/src/lib.rs/rust_main</code>\u51fd\u6570\u7684<code>unsafe{main();}</code>\u5165\u53e3\uff0c\u4ece\u800c\u8df3\u8f6c\u5230Arceos\u6307\u5b9a\u7684\u7528\u6237\u7a0b\u5e8f\uff08\u6ce8\u610f\uff1a\u867d\u7136\u662f\u7528\u6237\u7a0b\u5e8f\uff0c\u4f46\u662f\u8fd0\u884c\u5728arceos\u6846\u67b6\u4e0b\uff0c\u8fd8\u5904\u4e8e\u5185\u6838\u6001\uff09\uff0c\u5f00\u59cb\u52a0\u8f7d\u6d4b\u4f8b\u3002\u9ed8\u8ba4<code>make run</code>\u4f1a\u8fd0\u884c<code>apps/syscall/busybox</code>\u7a0b\u5e8f\u3002\u82e5\u6d4b\u4f8b\u7a0b\u5e8f\u4f1a\u901a\u8fc7<code>clone</code>\u7b49\u65b9\u5f0f\u751f\u6210\u65b0\u7684\u4efb\u52a1\uff0c\u90a3\u4e48\u65b0\u4efb\u52a1\u4f1a\u88ab\u52a0\u5165\u5230\u4efb\u52a1\u8c03\u5ea6\u961f\u5217\u7b49\u5f85\u88ab\u8c03\u5ea6\u3002</p> <ul> <li> <p>\u82e5\u8c03\u5ea6\u961f\u5217\u4e2d\u8fd8\u6709\u4efb\u52a1\u7b49\u5f85\u88ab\u8c03\u5ea6\uff0c\u90a3\u4e48\u5c31\u4f1a\u5207\u6362\u5230\u5bf9\u5e94\u4efb\u52a1\u3002\u6b64\u65f6\u82e5\u8c03\u5ea6\u7684\u4efb\u52a1\u662fgc\uff0c\u5219gc\u4f1a\u68c0\u6d4b\u662f\u5426\u8fd8\u6709\u4efb\u52a1\u9000\u51fa\u3002\u82e5\u6709\u4efb\u52a1\u5df2\u7ecf\u9000\u51fa\u7b49\u5f85\u56de\u6536\uff0c\u5219gc\u4f1a\u56de\u6536\u8fd9\u4e9b\u4efb\u52a1\u3002\u82e5\u6ca1\u6709\u5219\u963b\u585egc\u672c\u8eab\uff0c\u5207\u6362\u5230\u5176\u4ed6\u4efb\u52a1\u3002</p> <p>gc\u7684\u5b9e\u73b0\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>fn gc_entry() {\nloop {\n// Drop all exited tasks and recycle resources.\nwhile !EXITED_TASKS.lock().is_empty() {\n// Do not do the slow drops in the critical section.\nlet task = EXITED_TASKS.lock().pop_front();\nif let Some(task) = task {\n// If the task reference is not taken after `spawn()`, it will be\n// dropped here. Otherwise, it will be dropped after the reference\n// is dropped (usually by `join()`).\n// info!(\"drop task: {}\", task.id().as_u64());\ndrop(task);\n}\n}\nWAIT_FOR_EXIT.wait();\n}\n}\n</code></pre> </li> <li> <p>\u82e5\u8c03\u5ea6\u961f\u5217\u4e2d\u6ca1\u6709\u4e0b\u4e00\u4e2a\u4efb\u52a1\u65f6\uff0c\u5c31\u4f1a\u5207\u6362\u5230idle_task\uff0c\u6b64\u65f6\u4f1a\u6267\u884c<code>run_idle</code>\u51fd\u6570\uff0c\u5373\u4e0d\u65ad\u6267\u884c<code>yield_task</code>\u51fd\u6570\uff0c\u76f4\u5230\u6709\u65b0\u7684\u4efb\u52a1\u52a0\u5165\u8c03\u5ea6\u961f\u5217\uff0c\u5219\u5207\u6362\u5230\u5bf9\u5e94\u4efb\u52a1\u3002</p> <p>run_idle\u51fd\u6570\u5b9e\u73b0\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>pub fn run_idle() -&gt; ! {\nloop {\nyield_now();\ndebug!(\"idle task: waiting for IRQs...\");\n#[cfg(feature = \"irq\")]\naxhal::arch::wait_for_irqs();\n}\n}\n</code></pre> </li> <li> <p>\u591a\u6838\u542f\u52a8</p> </li> </ul> <p>\u6211\u4eec\u53ea\u8003\u8651\u4efb\u52a1\u8c03\u5ea6\u76f8\u5173\uff0c\u5219\u591a\u6838\u60c5\u51b5\u4e0b\uff0c\u5176\u4ed6\u6838\u521d\u59cb\u5316\u7684\u51fd\u6570\u5728<code>modules/axtask/src/monolithic_task/run_queue.rs/init_secondary</code>\u4e2d\uff0c\u4f1a\u65b0\u5efa\u4e00\u4e2a<code>idle_task</code>\uff0c\u4f46\u662f\u5b83\u7684\u529f\u80fd\u7c7b\u4f3c\u4e8e\u5355\u6838\u542f\u52a8\u4e0b\u7684<code>main_task</code>\uff0c\u5373\u521d\u59cb\u5316\u65f6\u6ca1\u6709\u4efb\u52a1\u4e0a\u4e0b\u6587\uff0c\u4f46\u662f\u53ef\u4ee5\u5728\u88ab\u5207\u6362\u4e4b\u540e\u4fdd\u7559\u5185\u6838\u7684\u4efb\u52a1\u6267\u884c\u6d41\u3002</p> <p>\u521d\u59cb\u5316\u5b8c\u6bd5\u4e4b\u540e\uff0c\u6bcf\u4e00\u4e2a\u975e\u4e3b\u6838\u6307\u5411\u4e00\u4e2a<code>idle_task</code>\uff0c\u6b64\u65f6\u4ed6\u4eec\u4f1a\u7ee7\u7eed\u6267\u884c\u5185\u6838\u4e2d\u7684\u521d\u59cb\u5316\u4ee3\u7801\uff0c\u6700\u540e\u5728<code>modules/axruntime/src/mp.rs</code>\u7684<code>rust_main_secondary</code>\u51fd\u6570\u4e2d\u6267\u884c<code>run_idle</code>\u51fd\u6570\uff0c\u5373\u4e0d\u65ad\u5730<code>yield</code>\u81ea\u5df1\uff0c\u76f4\u5230\u6709\u65b0\u7684\u4efb\u52a1\u52a0\u5165\u8c03\u5ea6\u961f\u5217\u3002</p> <p>\u5f53\u6d4b\u4f8b\u5bf9\u5e94\u7684\u7528\u6237\u6001\u4efb\u52a1\u6267\u884c<code>clone</code>\u7cfb\u7edf\u8c03\u7528\uff0c\u751f\u6210\u65b0\u7684\u4efb\u52a1\u52a0\u5165\u5230\u8c03\u5ea6\u961f\u5217\u65f6\uff0c\u6b64\u65f6\u5c31\u4f1a\u968f\u673a\u5206\u914d\u4e00\u4e2aCPU\u6838\u83b7\u5f97\u8be5\u4efb\u52a1\u5e76\u4e14\u8fdb\u884c\u6267\u884c\u3002\u8fd9\u5c31\u662f\u591a\u6838\u542f\u52a8\u7684\u539f\u7406\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97-axtask/#stat","title":"stat","text":"<p>stat\u5b9e\u73b0\u4e86\u4efb\u52a1\u7684\u65f6\u95f4\u8bb0\u5f55\u529f\u80fd\u548c\u8ba1\u65f6\u5668\u529f\u80fd\u3002</p> <p>\u8bb0\u5f55\u4efb\u52a1\u8fd0\u884c\u65f6\u95f4\u662f\u901a\u8fc7\u8ba1\u7b97\u548c\u66f4\u65b0\u65f6\u95f4\u6233\u8fdb\u884c\u7684\uff0c\u6bcf\u4e00\u4e2astat\u7ed3\u6784\u4f53\u90fd\u62e5\u6709\u5982\u4e0b\u7ed3\u6784\uff1a</p> <pre><code>/// \u7528\u6237\u6001\u7ecf\u8fc7\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u7eb3\u79d2\nutime_ns: usize,\n/// \u5185\u6838\u6001\u7ecf\u8fc7\u7684\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u7eb3\u79d2\nstime_ns: usize,\n/// \u8fdb\u5165\u7528\u6237\u6001\u65f6\u6807\u8bb0\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u7528\u4e8e\u7edf\u8ba1\u7528\u6237\u6001\u65f6\u95f4\nuser_tick: usize,\n/// \u8fdb\u5165\u5185\u6838\u6001\u65f6\u6807\u8bb0\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u7528\u4e8e\u7edf\u8ba1\u5185\u6838\u6001\u65f6\u95f4\nkernel_tick: usize,\n</code></pre> <p>\u66f4\u65b0\u65f6\u95f4\u6233\u7684\u65f6\u95f4\u70b9\u5171\u6709\u56db\u4e2a\uff1a</p> <ul> <li>\u4ece\u7528\u6237\u6001\u8fdb\u5165\u5185\u6838\u6001</li> <li>\u4ece\u5185\u6838\u6001\u8fdb\u5165\u7528\u6237\u6001</li> <li>\u5207\u6362\u5230\u672c\u4efb\u52a1</li> <li>\u672c\u4efb\u52a1\u88ab\u5207\u6362\u8d70</li> </ul> <p>\u76f8\u5173\u66f4\u65b0\u8fd0\u884c\u65f6\u95f4\u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>/// \u4ece\u7528\u6237\u6001\u8fdb\u5165\u5185\u6838\u6001\uff0c\u8bb0\u5f55\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u7edf\u8ba1\u7528\u6237\u6001\u65f6\u95f4\npub fn into_kernel_mode(&amp;mut self, tid: isize) {\nlet now_time_ns = current_time_nanos() as usize;\nlet delta = now_time_ns - self.user_tick;\nself.utime_ns += delta;\nself.kernel_tick = now_time_ns;\n}\n/// \u4ece\u5185\u6838\u6001\u8fdb\u5165\u7528\u6237\u6001\uff0c\u8bb0\u5f55\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u7edf\u8ba1\u5185\u6838\u6001\u65f6\u95f4\npub fn into_user_mode(&amp;mut self, tid: isize) {\n// \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u7eb3\u79d2\nlet now_time_ns = current_time_nanos() as usize;\nlet delta = now_time_ns - self.kernel_tick;\nself.stime_ns += delta;\nself.user_tick = now_time_ns;\n}\n/// \u5185\u6838\u6001\u4e0b\uff0c\u5f53\u524d\u4efb\u52a1\u88ab\u5207\u6362\u6389\uff0c\u7edf\u8ba1\u5185\u6838\u6001\u65f6\u95f4\npub fn swtich_from(&amp;mut self, tid: isize) {\n// \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u7eb3\u79d2\nlet now_time_ns = current_time_nanos() as usize;\nlet delta = now_time_ns - self.kernel_tick;\nself.stime_ns += delta;\n}\n/// \u5185\u6838\u6001\u4e0b\uff0c\u5207\u6362\u5230\u5f53\u524d\u4efb\u52a1\uff0c\u66f4\u65b0\u5185\u6838\u6001\u65f6\u95f4\u6233\npub fn switch_to(&amp;mut self, tid: isize) {\n// \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\uff0c\u5355\u4f4d\u4e3a\u7eb3\u79d2\nlet now_time_ns = current_time_nanos() as usize;\nlet delta = now_time_ns - self.kernel_tick;\n// \u66f4\u65b0\u65f6\u95f4\u6233\uff0c\u65b9\u4fbf\u5f53\u8be5\u4efb\u52a1\u88ab\u5207\u6362\u65f6\u7edf\u8ba1\u5185\u6838\u7ecf\u8fc7\u7684\u65f6\u95f4\nself.kernel_tick = now_time_ns;\n}\n</code></pre>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.6%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A8%A1%E5%9D%97-axtask/#_1","title":"4.6 \u4efb\u52a1\u8c03\u5ea6\u6a21\u5757-axtask","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.7%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97-axfs/","title":"4.7 \u6587\u4ef6\u7cfb\u7edf\u6a21\u5757-axfs","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.7%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97-axfs/#-axprocess","title":"\u8fdb\u7a0b\u63a7\u5236\u6a21\u5757--axprocess","text":"<p>\u8fdb\u7a0b\u90e8\u5206\u662f\u5b8f\u5185\u6838\u5b9e\u73b0\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u5b83\u4f5c\u4e3a\u4e00\u4e2a\u8d44\u6e90\u5bb9\u5668\u6536\u7eb3\u4e86\u4efb\u52a1\u3001\u4fe1\u53f7\u3001\u5185\u5b58\u3001\u6587\u4ef6\u7cfb\u7edf\u7b49\u6a21\u5757\u7684\u529f\u80fd\uff0c\u5e76\u4e14\u8fdb\u884c\u7edf\u7b79\u7ba1\u7406\u3002</p> <p>\u8fdb\u7a0b\u6a21\u5757\u7684\u76f8\u5173\u529f\u80fd\u5212\u5206\u5982\u4e0b</p> <p></p> <p>\u8fdb\u7a0b\u6a21\u5757\u66f4\u591a\u662f\u5bf9\u5df2\u6709\u5b9e\u73b0\u6a21\u5757\u7684\u4e00\u4e2a\u603b\u7ed3\uff0c \u56e0\u6b64\u8be5\u90e8\u5206\u7684\u989d\u5916\u8bf4\u660e\u5e76\u4e0d\u4f1a\u7279\u522b\u591a\uff0c\u4ec5\u662f\u8d77\u4e00\u4e2a\u603b\u7ed3\u7684\u4f5c\u7528\u3002</p> <p>\u989d\u5916\u8865\u5145\u5982\u4e0b</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.7%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97-axfs/#process","title":"process","text":"<p>process\u90e8\u5206\u5b9e\u73b0\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u4e3b\u4f53\u90e8\u5206\uff0c\u5176\u8fdb\u7a0b\u63a7\u5236\u5757\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>pub struct ProcessInner {\n/// \u7236\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7\npub parent: u64,\n/// \u5b50\u8fdb\u7a0b\npub children: Vec&lt;Arc&lt;Process&gt;&gt;,\n/// \u5b50\u4efb\u52a1\npub tasks: Vec&lt;AxTaskRef&gt;,\n/// \u5730\u5740\u7a7a\u95f4\uff0c\u7531\u4e8e\u5b58\u5728\u5730\u5740\u7a7a\u95f4\u5171\u4eab\uff0c\u56e0\u6b64\u8bbe\u8ba1\u4e3aArc\u7c7b\u578b\npub memory_set: Arc&lt;SpinNoIrq&lt;MemorySet&gt;&gt;,\n/// \u7528\u6237\u5806\u57fa\u5740\uff0c\u4efb\u4f55\u65f6\u5019\u5806\u9876\u90fd\u4e0d\u80fd\u6bd4\u8fd9\u4e2a\u503c\u5c0f\uff0c\u7406\u8bba\u4e0a\u8bb2\u662f\u4e00\u4e2a\u5e38\u91cf\npub heap_bottom: usize,\n/// \u5f53\u524d\u7528\u6237\u5806\u7684\u5806\u9876\uff0c\u4e0d\u80fd\u5c0f\u4e8e\u57fa\u5740\uff0c\u4e0d\u80fd\u5927\u4e8e\u57fa\u5740\u52a0\u5806\u7684\u6700\u5927\u5927\u5c0f\npub heap_top: usize,\n/// \u8fdb\u7a0b\u72b6\u6001\npub is_zombie: bool,\n/// \u9000\u51fa\u72b6\u6001\u7801\npub exit_code: i32,\n#[cfg(feature = \"fs\")]\npub fd_manager: FdManager,\n/// \u8fdb\u7a0b\u5de5\u4f5c\u76ee\u5f55\npub cwd: String,\n#[cfg(feature = \"signal\")]\n/// \u4fe1\u53f7\u5904\u7406\u6a21\u5757    \n/// \u7b2c\u4e00\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0c\u7b2c\u4e8c\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4fe1\u53f7\u5904\u7406\u6a21\u5757\npub signal_module: BTreeMap&lt;u64, SignalModule&gt;,\n\n/// robust list\u5b58\u50a8\u6a21\u5757\n/// \u7528\u6765\u5b58\u50a8\u7ebf\u7a0b\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u4f7f\u7528\u5730\u5740\n/// \u5177\u4f53\u4f7f\u7528\u4ea4\u7ed9\u4e86\u7528\u6237\u7a7a\u95f4\npub robust_list: BTreeMap&lt;u64, FutexRobustList&gt;,\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\u8fdb\u7a0b\u63a7\u5236\u5757\u5185\u878d\u5408\u4e86\u5305\u62ec\u6587\u4ef6\u3001\u4fe1\u53f7\u3001\u4e92\u65a5\u9501\u3001\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u7b49\u4e00\u7cfb\u5217\u5185\u5bb9\uff0c\u901a\u8fc7feature\u6761\u4ef6\u7f16\u8bd1\u7684\u65b9\u5f0f\u53ef\u4ee5\u65b9\u4fbf\u5730\u5bf9\u6a21\u5757\u8fdb\u884c\u53ef\u63d2\u62d4\u7f16\u8bd1\uff0c\u7b26\u5408\u6a21\u5757\u5316\u7684\u5185\u6838\u8bbe\u8ba1\u601d\u60f3\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.7%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9D%97-axfs/#futex","title":"futex","text":"<p>\u5728\u8fdb\u7a0b\u90e8\u5206\u5b9a\u4e49\u4e86\u4e0e\u4e92\u65a5\u9501\u76f8\u5173\u7684\u6570\u636e\u7ed3\u6784<code>FUTEX_WAIT_TASK</code>\uff0c\u5176\u662f\u4e00\u4e2a\u4ece\u5730\u5740\u5230\u4efb\u52a1\u6307\u9488\u7684map\u6620\u5c04\uff0c\u5b58\u50a8\u4e86\u6bcf\u4e00\u4e2afutex\u53d8\u91cf\u5bf9\u5e94\u7684\u6b63\u5728\u7b49\u5f85\u7684\u4efb\u52a1\u5e8f\u5217\u3002</p> <p>\u4e4b\u6240\u4ee5\u5c06\u8be5\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5728axprocess\u6a21\u5757\uff0c\u662f\u56e0\u4e3a\u9700\u8981\u5728\u8fdb\u7a0b\u9000\u51fa\u65f6\uff0c\u6e05\u7a7a<code>FUTEX_WAIT_TASK</code>\u4e2d\u5b58\u50a8\u7684\u8fdb\u7a0bArc\u6307\u9488\uff0c\u4ece\u800c\u4fdd\u8bc1\u5bf9\u8c61\u80fd\u591f\u5b8c\u6574\u88ab\u91ca\u653e\u3002</p> <p><code>futex</code>\u7684\u5b8c\u6574\u5b9e\u73b0\u5728<code>starry/syscall/futex</code>\u4e2d\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.8%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9D%97-axprocess/","title":"4.8 \u8fdb\u7a0b\u63a7\u5236\u6a21\u5757-axprocess","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.8%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9D%97-axprocess/#-axprocess","title":"\u8fdb\u7a0b\u63a7\u5236\u6a21\u5757--axprocess","text":"<p>\u8fdb\u7a0b\u90e8\u5206\u662f\u5b8f\u5185\u6838\u5b9e\u73b0\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u5b83\u4f5c\u4e3a\u4e00\u4e2a\u8d44\u6e90\u5bb9\u5668\u6536\u7eb3\u4e86\u4efb\u52a1\u3001\u4fe1\u53f7\u3001\u5185\u5b58\u3001\u6587\u4ef6\u7cfb\u7edf\u7b49\u6a21\u5757\u7684\u529f\u80fd\uff0c\u5e76\u4e14\u8fdb\u884c\u7edf\u7b79\u7ba1\u7406\u3002</p> <p>\u8fdb\u7a0b\u6a21\u5757\u7684\u76f8\u5173\u529f\u80fd\u5212\u5206\u5982\u4e0b</p> <p></p> <p>\u8fdb\u7a0b\u6a21\u5757\u66f4\u591a\u662f\u5bf9\u5df2\u6709\u5b9e\u73b0\u6a21\u5757\u7684\u4e00\u4e2a\u603b\u7ed3\uff0c \u56e0\u6b64\u8be5\u90e8\u5206\u7684\u989d\u5916\u8bf4\u660e\u5e76\u4e0d\u4f1a\u7279\u522b\u591a\uff0c\u4ec5\u662f\u8d77\u4e00\u4e2a\u603b\u7ed3\u7684\u4f5c\u7528\u3002</p> <p>\u989d\u5916\u8865\u5145\u5982\u4e0b</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.8%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9D%97-axprocess/#process","title":"process","text":"<p>process\u90e8\u5206\u5b9e\u73b0\u4e86\u8fdb\u7a0b\u63a7\u5236\u5757\u7684\u4e3b\u4f53\u90e8\u5206\uff0c\u5176\u8fdb\u7a0b\u63a7\u5236\u5757\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>pub struct ProcessInner {\n/// \u7236\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7\npub parent: u64,\n/// \u5b50\u8fdb\u7a0b\npub children: Vec&lt;Arc&lt;Process&gt;&gt;,\n/// \u5b50\u4efb\u52a1\npub tasks: Vec&lt;AxTaskRef&gt;,\n/// \u5730\u5740\u7a7a\u95f4\uff0c\u7531\u4e8e\u5b58\u5728\u5730\u5740\u7a7a\u95f4\u5171\u4eab\uff0c\u56e0\u6b64\u8bbe\u8ba1\u4e3aArc\u7c7b\u578b\npub memory_set: Arc&lt;SpinNoIrq&lt;MemorySet&gt;&gt;,\n/// \u7528\u6237\u5806\u57fa\u5740\uff0c\u4efb\u4f55\u65f6\u5019\u5806\u9876\u90fd\u4e0d\u80fd\u6bd4\u8fd9\u4e2a\u503c\u5c0f\uff0c\u7406\u8bba\u4e0a\u8bb2\u662f\u4e00\u4e2a\u5e38\u91cf\npub heap_bottom: usize,\n/// \u5f53\u524d\u7528\u6237\u5806\u7684\u5806\u9876\uff0c\u4e0d\u80fd\u5c0f\u4e8e\u57fa\u5740\uff0c\u4e0d\u80fd\u5927\u4e8e\u57fa\u5740\u52a0\u5806\u7684\u6700\u5927\u5927\u5c0f\npub heap_top: usize,\n/// \u8fdb\u7a0b\u72b6\u6001\npub is_zombie: bool,\n/// \u9000\u51fa\u72b6\u6001\u7801\npub exit_code: i32,\n#[cfg(feature = \"fs\")]\npub fd_manager: FdManager,\n/// \u8fdb\u7a0b\u5de5\u4f5c\u76ee\u5f55\npub cwd: String,\n#[cfg(feature = \"signal\")]\n/// \u4fe1\u53f7\u5904\u7406\u6a21\u5757    \n/// \u7b2c\u4e00\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0c\u7b2c\u4e8c\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4fe1\u53f7\u5904\u7406\u6a21\u5757\npub signal_module: BTreeMap&lt;u64, SignalModule&gt;,\n\n/// robust list\u5b58\u50a8\u6a21\u5757\n/// \u7528\u6765\u5b58\u50a8\u7ebf\u7a0b\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u4f7f\u7528\u5730\u5740\n/// \u5177\u4f53\u4f7f\u7528\u4ea4\u7ed9\u4e86\u7528\u6237\u7a7a\u95f4\npub robust_list: BTreeMap&lt;u64, FutexRobustList&gt;,\n}\n</code></pre> <p>\u53ef\u4ee5\u770b\u51fa\u8fdb\u7a0b\u63a7\u5236\u5757\u5185\u878d\u5408\u4e86\u5305\u62ec\u6587\u4ef6\u3001\u4fe1\u53f7\u3001\u4e92\u65a5\u9501\u3001\u5185\u5b58\u5730\u5740\u7a7a\u95f4\u7b49\u4e00\u7cfb\u5217\u5185\u5bb9\uff0c\u901a\u8fc7feature\u6761\u4ef6\u7f16\u8bd1\u7684\u65b9\u5f0f\u53ef\u4ee5\u65b9\u4fbf\u5730\u5bf9\u6a21\u5757\u8fdb\u884c\u53ef\u63d2\u62d4\u7f16\u8bd1\uff0c\u7b26\u5408\u6a21\u5757\u5316\u7684\u5185\u6838\u8bbe\u8ba1\u601d\u60f3\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.8%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%9D%97-axprocess/#futex","title":"futex","text":"<p>\u5728\u8fdb\u7a0b\u90e8\u5206\u5b9a\u4e49\u4e86\u4e0e\u4e92\u65a5\u9501\u76f8\u5173\u7684\u6570\u636e\u7ed3\u6784<code>FUTEX_WAIT_TASK</code>\uff0c\u5176\u662f\u4e00\u4e2a\u4ece\u5730\u5740\u5230\u4efb\u52a1\u6307\u9488\u7684map\u6620\u5c04\uff0c\u5b58\u50a8\u4e86\u6bcf\u4e00\u4e2afutex\u53d8\u91cf\u5bf9\u5e94\u7684\u6b63\u5728\u7b49\u5f85\u7684\u4efb\u52a1\u5e8f\u5217\u3002</p> <p>\u4e4b\u6240\u4ee5\u5c06\u8be5\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u5728axprocess\u6a21\u5757\uff0c\u662f\u56e0\u4e3a\u9700\u8981\u5728\u8fdb\u7a0b\u9000\u51fa\u65f6\uff0c\u6e05\u7a7a<code>FUTEX_WAIT_TASK</code>\u4e2d\u5b58\u50a8\u7684\u8fdb\u7a0bArc\u6307\u9488\uff0c\u4ece\u800c\u4fdd\u8bc1\u5bf9\u8c61\u80fd\u591f\u5b8c\u6574\u88ab\u91ca\u653e\u3002</p> <p><code>futex</code>\u7684\u5b8c\u6574\u5b9e\u73b0\u5728<code>starry/syscall/futex</code>\u4e2d\u3002</p>"},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.9%E5%86%85%E6%A0%B8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%A8%A1%E5%9D%97-axruntime/","title":"4.9 \u5185\u6838\u8fd0\u884c\u65f6\u6a21\u5757-axruntime","text":""},{"location":"4.%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/4.9%E5%86%85%E6%A0%B8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%A8%A1%E5%9D%97-axruntime/#-axruntime","title":"\u5185\u6838\u8fd0\u884c\u65f6\u6a21\u5757--axruntime","text":"<p>axruntime\u4f5c\u4e3a\u5185\u6838\u8fd0\u884c\u65f6\u6a21\u5757\uff0c\u7edf\u7b79\u4e86\u5176\u4ed6\u6240\u6709\u7684\u5185\u6838\u6a21\u5757\u3002\u6839\u636e\u5185\u6838\u6a21\u5757\u4f9d\u8d56\u56fe\u53ef\u77e5\uff0cruntimer\u6a21\u5757\u662f\u6700\u4e0a\u5c42\u7684\u6a21\u5757\uff0c\u5b83\u66f4\u591a\u7684\u662f\u8c03\u7528\u5176\u4ed6\u6a21\u5757\u5bf9\u5916\u63d0\u4f9b\u7684\u63a5\u53e3\u6765\u542f\u52a8\u5185\u6838\uff0c\u5e76\u6ca1\u6709\u8fc7\u591a\u7684\u65b0\u589e\u529f\u80fd\uff0c\u56e0\u6b64\u6211\u4eec\u4ec5\u5728\u8fd9\u90e8\u5206\u7b80\u5355\u9610\u8ff0Starry\u5185\u6838\u7684\u542f\u52a8\u6d41\u7a0b\u3002</p> <p>\u8be6\u7ec6\u4ee3\u7801\u53c2\u89c1<code>axruntime/src/lib.rs:107</code>\uff0c\u5176\u542f\u52a8\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u5b9e\u73b0alloc trait\uff0c\u4ece\u800c\u5b9e\u73b0\u5168\u5c40\u5206\u914d\u5668</li> <li>\u5efa\u7acb\u5185\u6838\u5730\u5740\u7a7a\u95f4\uff0c\u5212\u5206\u5730\u5740\u6bb5</li> <li>\u521d\u59cb\u5316\u5e73\u53f0\u914d\u7f6e\uff0c\u5305\u62ec\u591a\u6838CPU\u5b9a\u4e49\u7684\u521d\u59cb\u5316</li> <li>\u5efa\u7acb\u5185\u6838\u8fdb\u7a0b\uff0c\u521d\u59cb\u5316\u5efa\u7acbidle task\u548cgc task\uff0c\u542f\u52a8\u4efb\u52a1\u8c03\u5ea6\u5e8f\u5217</li> <li>\u542f\u52a8\u5916\u7f6e\u9a71\u52a8\uff0c\u5305\u62ecfs\u3001display\u3001net</li> <li>\u82e5\u6709\u591a\u6838\u5219\u542f\u52a8\u591a\u6838\u5165\u53e3\u51fd\u6570</li> <li>\u521d\u59cb\u5316\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u51fd\u6570</li> <li>\u8fd0\u884c\u4e3b\u6838\u7684\u4e3b\u51fd\u6570\uff0c\u5373\u8fd0\u884c\u6307\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f</li> </ol> <p>\u6bd4\u8d5b\u65f6\u9700\u8981\u6709\u51e0\u70b9\u6ce8\u610f\u7684\u5730\u65b9\uff1a</p> <ol> <li>\u4e3a\u9075\u5faa\u6bd4\u8d5b\u9700\u6c42\uff0cstarry\u9700\u8981\u8bfb\u53d6\u5916\u90e8\u6d4b\u4f8b\u955c\u50cf\u3002\u4f46\u7531\u4e8eSD\u5361\u955c\u50cf\u8bfb\u53d6\u9a71\u52a8\u8f83\u4e3a\u590d\u6742\uff0c\u56e0\u6b64\u6bd4\u8d5b\u4e2d\u9ed8\u8ba4\u5c06\u5df2\u6709\u7684SD\u5361\u955c\u50cf\u901a\u8fc7\u7f51\u7edc\u4f20\u8f93\u7684\u65b9\u5f0f\u4f20\u9012\u5230\u5b9e\u9645\u677f\u5b50\u7684<code>0x90000000</code>\u7269\u7406\u5730\u5740\u5904\u3002\u56e0\u6b64\u8bbe\u7f6e\u5185\u6838\u5730\u5740\u7a7a\u95f4\u65f6\uff0c\u9700\u8981\u5c06\u8fd9\u6bb5\u7a7a\u7f6e\u51fa\u6765\u3002\u5f53\u524dStarry\u9ed8\u8ba4\u542f\u52a8\u7684\u7269\u7406\u5185\u5b58\u5360\u7528\u4e3a[0x8000_0000,0x8800_0000)\u4e0e[0xa000_0000, 0xc000_0000)\u3002\u5bf9\u5e94\u7684\u7279\u6b8a\u5904\u7406\u5728<code>axhal/src/platform/qemu_virt_riscv/mem.rs</code>\u4e2d\u3002</li> <li>\u5b9e\u9645\u4e0a\u677f\u65f6\uff0c\u7531\u4e8efu740\u4e0d\u5b58\u5728virt-io\u8bbe\u5907\uff0c\u56e0\u6b64\u9700\u8981\u6ce8\u610f\u4e0d\u80fd\u76f4\u63a5\u5c06\u865a\u62df\u8bbe\u5907\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u95ee\u9898\u3002</li> </ol>"},{"location":"5.%E5%AE%9E%E7%8E%B0%E9%87%8D%E7%82%B9/5.1%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98/","title":"5.1 \u4f9d\u8d56\u95ee\u9898","text":""},{"location":"5.%E5%AE%9E%E7%8E%B0%E9%87%8D%E7%82%B9/5.1%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98/#_1","title":"\u517c\u5bb9\u95ee\u9898","text":"<p>\u4e3a\u4e86\u4fdd\u8bc1Starry\u5728\u672a\u6765\u7684\u6cdb\u7528\u6027\uff0c\u6211\u4eec\u5728\u6bd4\u8d5b\u5f00\u53d1\u8fc7\u7a0b\u4e2d\u4fbf\u6709\u610f\u8bc6\u5730\u53bb\u6ce8\u610f\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u5b9e\u73b0\u517c\u5bb9\uff0c\u5e76\u91c7\u7528\u6761\u4ef6\u7f16\u8bd1\u7b49\u65b9\u5f0f\u8fdb\u884c\u533a\u5206\u3002\u5982process\u90e8\u5206\u7684\u7ed3\u6784\u4f53\u7684\u5b9a\u4e49\u4e3a\uff1a</p> <pre><code>pub struct ProcessInner {\n/// \u7236\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7\npub parent: u64,\n/// \u5b50\u8fdb\u7a0b\npub children: Vec&lt;Arc&lt;Process&gt;&gt;,\n/// \u5b50\u4efb\u52a1\npub tasks: Vec&lt;AxTaskRef&gt;,\n/// \u5730\u5740\u7a7a\u95f4\uff0c\u7531\u4e8e\u5b58\u5728\u5730\u5740\u7a7a\u95f4\u5171\u4eab\uff0c\u56e0\u6b64\u8bbe\u8ba1\u4e3aArc\u7c7b\u578b\npub memory_set: Arc&lt;SpinNoIrq&lt;MemorySet&gt;&gt;,\n/// \u7528\u6237\u5806\u57fa\u5740\uff0c\u4efb\u4f55\u65f6\u5019\u5806\u9876\u90fd\u4e0d\u80fd\u6bd4\u8fd9\u4e2a\u503c\u5c0f\uff0c\u7406\u8bba\u4e0a\u8bb2\u662f\u4e00\u4e2a\u5e38\u91cf\npub heap_bottom: usize,\n/// \u5f53\u524d\u7528\u6237\u5806\u7684\u5806\u9876\uff0c\u4e0d\u80fd\u5c0f\u4e8e\u57fa\u5740\uff0c\u4e0d\u80fd\u5927\u4e8e\u57fa\u5740\u52a0\u5806\u7684\u6700\u5927\u5927\u5c0f\npub heap_top: usize,\n/// \u8fdb\u7a0b\u72b6\u6001\npub is_zombie: bool,\n/// \u9000\u51fa\u72b6\u6001\u7801\npub exit_code: i32,\n// /// \u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\n// pub fd_table: Vec&lt;Option&lt;Arc&lt;SpinNoIrq&lt;dyn FileIO&gt;&gt;&gt;&gt;,\n// /// \u6587\u4ef6\u63cf\u8ff0\u7b26\u4e0a\u9650\uff0c\u7531prlimit\u8bbe\u7f6e\n// pub fd_limit: usize,\n#[cfg(feature = \"fs\")]\npub fd_manager: FdManager,\n/// \u8fdb\u7a0b\u5de5\u4f5c\u76ee\u5f55\npub cwd: String,\n#[cfg(feature = \"signal\")]\n/// \u4fe1\u53f7\u5904\u7406\u6a21\u5757    \n/// \u7b2c\u4e00\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0c\u7b2c\u4e8c\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4fe1\u53f7\u5904\u7406\u6a21\u5757\npub signal_module: BTreeMap&lt;u64, SignalModule&gt;,\n\n/// robust list\u5b58\u50a8\u6a21\u5757\n/// \u7528\u6765\u5b58\u50a8\u7ebf\u7a0b\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u4f7f\u7528\u5730\u5740\n/// \u5177\u4f53\u4f7f\u7528\u4ea4\u7ed9\u4e86\u7528\u6237\u7a7a\u95f4\npub robust_list: BTreeMap&lt;u64, FutexRobustList&gt;,\n}\n</code></pre> <p>\u5176\u989d\u5916\u9650\u5b9a\u4e86fs\u548csignal\u7684feature\uff0c\u89c4\u5b9a\u4e86\u4fe1\u53f7\u6a21\u5757\u548c\u6587\u4ef6\u7cfb\u7edf\u6a21\u5757\u7684\u6761\u4ef6\u7f16\u8bd1\uff0c\u53ef\u4ee5\u6839\u636e\u7f16\u8bd1\u53c2\u6570\u6765\u51b3\u5b9a\u5185\u6838\u662f\u5426\u652f\u6301fs\u548c\u4fe1\u53f7\u6a21\u5757\u3002</p>"},{"location":"5.%E5%AE%9E%E7%8E%B0%E9%87%8D%E7%82%B9/5.2%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98/","title":"5.2 \u517c\u5bb9\u95ee\u9898","text":""},{"location":"5.%E5%AE%9E%E7%8E%B0%E9%87%8D%E7%82%B9/5.2%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98/#_1","title":"\u517c\u5bb9\u95ee\u9898","text":"<p>\u4e3a\u4e86\u4fdd\u8bc1Starry\u5728\u672a\u6765\u7684\u6cdb\u7528\u6027\uff0c\u6211\u4eec\u5728\u6bd4\u8d5b\u5f00\u53d1\u8fc7\u7a0b\u4e2d\u4fbf\u6709\u610f\u8bc6\u5730\u53bb\u6ce8\u610f\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u5b9e\u73b0\u517c\u5bb9\uff0c\u5e76\u91c7\u7528\u6761\u4ef6\u7f16\u8bd1\u7b49\u65b9\u5f0f\u8fdb\u884c\u533a\u5206\u3002\u5982process\u90e8\u5206\u7684\u7ed3\u6784\u4f53\u7684\u5b9a\u4e49\u4e3a\uff1a</p> <pre><code>pub struct ProcessInner {\n/// \u7236\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7\npub parent: u64,\n/// \u5b50\u8fdb\u7a0b\npub children: Vec&lt;Arc&lt;Process&gt;&gt;,\n/// \u5b50\u4efb\u52a1\npub tasks: Vec&lt;AxTaskRef&gt;,\n/// \u5730\u5740\u7a7a\u95f4\uff0c\u7531\u4e8e\u5b58\u5728\u5730\u5740\u7a7a\u95f4\u5171\u4eab\uff0c\u56e0\u6b64\u8bbe\u8ba1\u4e3aArc\u7c7b\u578b\npub memory_set: Arc&lt;SpinNoIrq&lt;MemorySet&gt;&gt;,\n/// \u7528\u6237\u5806\u57fa\u5740\uff0c\u4efb\u4f55\u65f6\u5019\u5806\u9876\u90fd\u4e0d\u80fd\u6bd4\u8fd9\u4e2a\u503c\u5c0f\uff0c\u7406\u8bba\u4e0a\u8bb2\u662f\u4e00\u4e2a\u5e38\u91cf\npub heap_bottom: usize,\n/// \u5f53\u524d\u7528\u6237\u5806\u7684\u5806\u9876\uff0c\u4e0d\u80fd\u5c0f\u4e8e\u57fa\u5740\uff0c\u4e0d\u80fd\u5927\u4e8e\u57fa\u5740\u52a0\u5806\u7684\u6700\u5927\u5927\u5c0f\npub heap_top: usize,\n/// \u8fdb\u7a0b\u72b6\u6001\npub is_zombie: bool,\n/// \u9000\u51fa\u72b6\u6001\u7801\npub exit_code: i32,\n// /// \u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\n// pub fd_table: Vec&lt;Option&lt;Arc&lt;SpinNoIrq&lt;dyn FileIO&gt;&gt;&gt;&gt;,\n// /// \u6587\u4ef6\u63cf\u8ff0\u7b26\u4e0a\u9650\uff0c\u7531prlimit\u8bbe\u7f6e\n// pub fd_limit: usize,\n#[cfg(feature = \"fs\")]\npub fd_manager: FdManager,\n/// \u8fdb\u7a0b\u5de5\u4f5c\u76ee\u5f55\npub cwd: String,\n#[cfg(feature = \"signal\")]\n/// \u4fe1\u53f7\u5904\u7406\u6a21\u5757    \n/// \u7b2c\u4e00\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u53f7\uff0c\u7b2c\u4e8c\u7ef4\u4ee3\u8868\u7ebf\u7a0b\u5bf9\u5e94\u7684\u4fe1\u53f7\u5904\u7406\u6a21\u5757\npub signal_module: BTreeMap&lt;u64, SignalModule&gt;,\n\n/// robust list\u5b58\u50a8\u6a21\u5757\n/// \u7528\u6765\u5b58\u50a8\u7ebf\u7a0b\u5bf9\u5171\u4eab\u53d8\u91cf\u7684\u4f7f\u7528\u5730\u5740\n/// \u5177\u4f53\u4f7f\u7528\u4ea4\u7ed9\u4e86\u7528\u6237\u7a7a\u95f4\npub robust_list: BTreeMap&lt;u64, FutexRobustList&gt;,\n}\n</code></pre> <p>\u5176\u989d\u5916\u9650\u5b9a\u4e86fs\u548csignal\u7684feature\uff0c\u89c4\u5b9a\u4e86\u4fe1\u53f7\u6a21\u5757\u548c\u6587\u4ef6\u7cfb\u7edf\u6a21\u5757\u7684\u6761\u4ef6\u7f16\u8bd1\uff0c\u53ef\u4ee5\u6839\u636e\u7f16\u8bd1\u53c2\u6570\u6765\u51b3\u5b9a\u5185\u6838\u662f\u5426\u652f\u6301fs\u548c\u4fe1\u53f7\u6a21\u5757\u3002</p>"},{"location":"6.%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3/6.1%E9%97%AE%E9%A2%98/","title":"6.1 \u95ee\u9898","text":""},{"location":"6.%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3/6.1%E9%97%AE%E9%A2%98/#csr","title":"\u64cd\u4f5cCSR\u5bc4\u5b58\u5668\u65f6\u5173\u95ed\u65f6\u949f\u4e2d\u65ad","text":"<p>\u7531\u4e8e\u8981\u8fd0\u884c\u591a\u4e2a\u6d4b\u4f8b\uff0c\u6bcf\u4e00\u4e2a\u6d4b\u4f8b\u90fd\u662f\u5355\u72ec\u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u800c\u5f53\u6d4b\u4f8b\u91cf\u52a0\u5927\u65f6\uff0c\u4f1a\u7ecf\u5e38\u6027\u51fa\u73b0\u51c6\u5907\u5f00\u59cb\u8fd0\u884c\u67d0\u4e2a\u6d4b\u4f8b\u7684\u65f6\u5019\u5361\u6b7b\u6216\u8005\u5faa\u73af\u53d1\u751f\u5185\u6838trap\u7684\u73b0\u8c61\uff0c\u9519\u8bef\u7684\u5185\u5bb9\u662f\u968f\u673a\u7684\uff0c\u53ef\u80fd\u5448\u73b0\u4e3astore fault\u3001\u5361\u6b7b\u751a\u81f3unknown trap\u7b49\u5185\u5bb9\u3002</p> <p>\u901a\u8fc7gdb\u8c03\u8bd5\uff0c\u5b9a\u4f4d\u4e86\u7b2c\u4e00\u6b21\u53d1\u751f\u9519\u8bef\u7684\u5730\u5740\u5747\u5728\u4e0b\u5217\u51fd\u6570\u4e2d\uff1a</p> <pre><code>#[no_mangle]\n// #[cfg(feature = \"user\")]\nfn first_into_user(kernel_sp: usize, frame_base: usize) -&gt; ! {\nlet trap_frame_size = core::mem::size_of::&lt;TrapFrame&gt;();\nlet kernel_base = kernel_sp - trap_frame_size;\nunsafe {\nasm::sfence_vma_all();\ncore::arch::asm!(\nr\"\n            mv      sp, {frame_base}\n            .short  0x2432                      // fld fs0,264(sp)\n            .short  0x24d2                      // fld fs1,272(sp)\n            LDR     gp, sp, 2                   // load user gp and tp\n            LDR     t0, sp, 3\n            mv      t1, {kernel_base}\n            STR     tp, t1, 3                   // save supervisor tp\uff0c\u6ce8\u610f\u662f\u5b58\u50a8\u5230\u5185\u6838\u6808\u4e0a\u800c\u4e0d\u662fsp\u4e2d\uff0c\u6b64\u65f6\u5b58\u50a8\u7684\u5e94\u8be5\u662f\u5f53\u524d\u8fd0\u884c\u7684CPU\u7684ID\n            mv      tp, t0                      // tp\uff1a\u672c\u6765\u5b58\u50a8\u7684\u662fCPU ID\uff0c\u5728\u8fd9\u4e2a\u65f6\u5019\u53d8\u6210\u4e86\u5bf9\u5e94\u7ebf\u7a0b\u7684TLS \u6307\u9488\n            csrw    sscratch, {kernel_sp}       // put supervisor sp to scratch\n            LDR     t0, sp, 31\n            LDR     t1, sp, 32\n            csrw    sepc, t0\n            csrw    sstatus, t1\n            POP_GENERAL_REGS\n            LDR     sp, sp, 1\n            sret\n        \",\nframe_base = in(reg) frame_base,\nkernel_sp = in(reg) kernel_sp,\nkernel_base = in(reg) kernel_base,\n);\n};\ncore::panic!(\"already in user mode!\")\n}\n</code></pre> <p>\u7ee7\u7eed\u5b9a\u4f4dgdb\u6c47\u7f16\u4ee3\u7801\uff0c\u5c06\u9519\u8bef\u5730\u5740\u8fdb\u4e00\u6b65\u786e\u5b9a\u4e3a\uff1a</p> <pre><code>csrw    sstatus, t1\n</code></pre> <p>\u5f53\u6267\u884c\u8fd9\u4e00\u6761\u6c47\u7f16\u4ee3\u7801\uff0c\u4f1a\u51fa\u73b0\u4e0d\u53ef\u9884\u6d4b\u7684\u9519\u8bef\u3002</p> <p>\u8003\u8651\u5230sstatus\u7684\u529f\u80fd\uff0c\u5176\u53ef\u4ee5\u63a7\u5236\u65f6\u949f\u4e2d\u65ad\u3001\u7279\u6743\u7ea7\u7b49\u4e00\u7cfb\u5217\u7684\u5185\u5bb9\uff0c\u901a\u8fc7\u67e5\u9605\u8d44\u6599\u4e86\u89e3\u5230\u5f53\u4f7f\u7528sstatus\u5c4f\u853d\u5185\u6838\u4e2d\u65f6\u949f\u4e2d\u65ad\u65f6\uff0c\u5e76\u975e\u662f\u963b\u6b62\u4e86\u4e2d\u65ad\u53d1\u51fa\uff0c\u800c\u662f\u963b\u6b62\u5bf9\u4e2d\u65ad\u8fdb\u884c\u5904\u7406\uff0c\u4e00\u65e6\u5185\u6838\u4e2d\u65f6\u949f\u4e2d\u65ad\u5c4f\u853d\u5173\u95ed\uff0c\u539f\u5148\u79ef\u7d2f\u7684\u65f6\u949f\u4e2d\u65ad\u4f1a\u88ab\u7528\u6765\u5904\u7406\u3002sstatus\u662f\u63a7\u5236\u4e2d\u65ad\u7684\u5173\u952e\u5bc4\u5b58\u5668\uff0c\u67e5\u9605\u8d44\u6599\u5f97\u77e5\uff0criscv\u8981\u6c42\u5728\u4fee\u6539sstatus\u4fe1\u606f\u7684\u65f6\u5019\u9700\u8981\u4fdd\u8bc1\u65f6\u949f\u4e2d\u65ad\u4f7f\u80fd\u5173\u95ed\uff0c\u5426\u5219\u4f1a\u4ea7\u751f\u4e0d\u53ef\u9884\u6599\u7684\u884c\u4e3a\u3002</p> <p>\u56e0\u6b64\u5728\u8c03\u7528<code>first_into_user</code>\u51fd\u6570\u524d\u9700\u8981\u624b\u52a8\u8c03\u7528<code>axhal::arch::enable_irqs()</code>\u5173\u95ed\u4e2d\u65ad\u4f7f\u80fd\u3002  </p>"},{"location":"6.%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3/6.1%E9%97%AE%E9%A2%98/#_1","title":"\u8bfb\u53d6\u957f\u5ea6\u4e0d\u8db3","text":"<p>\u5f53\u8bfb\u53d6<code>strings.lua</code>\u6d4b\u4f8b\u65f6\uff0c\u5e38\u4f1a\u6709\u62a5\u9519\uff1a<code>strings.lua:1: unexpected symbol</code>\u3002\u4f46\u5176\u4ed6lua\u6d4b\u4f8b\u8fd0\u884c\u7ed3\u679c\u6b63\u5e38\u4e14\u6b63\u786e\u3002</p> <p>strings.lua\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>local str = \"Jelly Think\"\n\nresult = 0\n\n-- string.len\u53ef\u4ee5\u83b7\u5f97\u5b57\u7b26\u4e32\u7684\u957f\u5ea6\n\nif string.len(str) ~= 11 then\n    result = -1\nend\n\n-- string.rep\u8fd4\u56de\u5b57\u7b26\u4e32\u91cd\u590dn\u6b21\u7684\u7ed3\u679c\n\nstr = \"ab\"\n\nif string.rep(str, 2) ~= \"abab\" then\n    result = -1\nend\n\n-- string.lower\u5c06\u5b57\u7b26\u4e32\u5c0f\u5199\u53d8\u6210\u5927\u5199\u5f62\u5f0f\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u6539\u53d8\u4ee5\u540e\u7684\u526f\u672c\n\nstr = \"Jelly Think\"\n\nif string.lower(str) ~= \"jelly think\" then\n    result = -1\nend\n\n-- string.upper\u5c06\u5b57\u7b26\u4e32\u5927\u5199\u53d8\u6210\u5c0f\u5199\u5f62\u5f0f\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u6539\u53d8\u4ee5\u540e\u7684\u526f\u672c\n\nif string.upper(str) == \"JELLY THINK\" then\n    result = -1\nend\n\nreturn result\n</code></pre> <p>\u8003\u8651\u662f\u5426\u662f\u6587\u4ef6\u7f16\u7801\u95ee\u9898\uff1a\u5c06strings.lua\u6d4b\u4f8b\u5185\u5bb9\u590d\u5236\u5230\u5176\u4ed6lua\u6587\u4ef6\uff0c\u8fd0\u884c\u5bf9\u5e94\u6587\u4ef6\uff0c\u62a5\u9519\u4e0d\u53d8\u3002\u5c06\u5176\u4ed6lua\u6587\u4ef6\u5185\u5bb9\u590d\u5236\u5230strings.lua\uff0c\u8fd0\u884cstrings.lua\uff0c\u7ed3\u679c\u6b63\u5e38\uff0c\u56e0\u6b64\u6392\u9664\u4e86\u7f16\u7801\u95ee\u9898\u3002</p> <p>\u518d\u8003\u8651\u5185\u6838\u662f\u5426\u6210\u529f\u8bfb\u5165\u6587\u4ef6\uff0c\u8f93\u51fa<code>read</code>\u7cfb\u7edf\u8c03\u7528\u5185\u5bb9\uff0c\u53d1\u73b0read\u7cfb\u7edf\u8c03\u7528\u786e\u5b9e\u6b63\u786e\u8bfb\u5165\u5e76\u8fd4\u56de\u4e86\u6587\u4ef6\u957f\u5ea6591\u3002</p> <p>\u8003\u8651\u5230strings.lua\u6d4b\u8bd5\u5185\u5bb9\u7531\u591a\u4e2a\u65ad\u8a00\u5f62\u6210\uff0c\u8003\u8651\u9010\u4e2a\u65ad\u8a00\u9010\u4e2a\u65ad\u8a00\u9a8c\u8bc1\uff0c\u4f46\u53d1\u73b0\u4e00\u65e6\u5220\u9664\u4e86strings.lua\u7684\u90e8\u5206\u5185\u5bb9\u4e4b\u540e\uff0c\u8fd0\u884c\u7ed3\u679c\u5c31\u6b63\u5e38\u4e86\u3002\u5373\u5f53\u7f29\u77ed\u4e86strings.lua\u7684\u957f\u5ea6\u4e4b\u540e\uff0c\u7ed3\u679c\u6b63\u5e38\u3002</p> <p>\u8003\u8651\u8f93\u51faread\u7cfb\u7edf\u8c03\u7528\u4e2d\u8bfb\u5165\u7684buf\u7684\u5185\u5bb9\uff0c\u53d1\u73b0\u8bfb\u5165\u7684892\u4f4dbuf\u4e2d\uff0c\u524d512\u4f4dbuf\u88ab\u4fee\u6539\u4e3a\u4e860\uff0c\u540e\u9762\u7684buf\u4ecd\u7136\u6b63\u5e38\u3002\u800c\u5f53\u9650\u5236buf\u957f\u5ea6\u4e3a512\u65f6\uff0c\u6b64\u65f6\u524d512\u4f4dbuf\u8bfb\u53d6\u7ed3\u679c\u6b63\u5e38\u3002</p> <p>arceos\u539f\u5148\u5728fat32\u8282\u70b9\u7684\u8bfb\u53d6\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>fn read_at(&amp;self, offset: u64, buf: &amp;mut [u8]) -&gt; VfsResult&lt;usize&gt; {\nlet mut file = self.0.lock();\nfile.seek(SeekFrom::Start(offset)).map_err(as_vfs_err)?; // TODO: more efficient\nfile.read(buf).map_err(as_vfs_err)\n}\n</code></pre> <p>\u4f9d\u636e\u4e0a\u8ff0debug\u7ed3\u679c\uff0c\u53d1\u73b0starry\u7684\u6587\u4ef6\u7cfb\u7edf\u9a71\u52a8\u4e2dfat32\u7684\u5757\u5927\u5c0f\u5b9a\u4e49\u4e3a512\u3002\u67e5\u8be2read\u8bed\u4e49\u77e5\uff0c\u6bcf\u4e00\u6b21\u5b9e\u9645\u8bfb\u53d6\u957f\u5ea6\u4e0d\u4e00\u5b9a\u7b49\u4e8e\u4f20\u5165\u7684buf\u957f\u5ea6\uff0c\u56e0\u6b64\u4e0d\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u4f20\u5165buf\u6765\u5b9e\u73b0\u6587\u4ef6\u7684\u8bfb\u5165\uff0c\u800c\u9700\u8981\u8fdb\u884c\u5faa\u73af\u5224\u65ad\uff1a</p> <pre><code>n read_at(&amp;self, offset: u64, buf: &amp;mut [u8]) -&gt; VfsResult&lt;usize&gt; {\nlet mut file = self.0.lock();\nfile.seek(SeekFrom::Start(offset)).map_err(as_vfs_err)?; // TODO: more efficient\n// file.read(buf).map_err(as_vfs_err)\nlet buf_len = buf.len();\nlet mut now_offset = 0;\nlet mut probe = buf.to_vec();\nwhile now_offset &lt; buf_len {\nlet ans = file.read(&amp;mut probe).map_err(as_vfs_err);\nif ans.is_err() {\nreturn ans;\n}\nlet read_len = ans.unwrap();\n\nif read_len == 0 {\nbreak;\n}\nbuf[now_offset..now_offset + read_len].copy_from_slice(&amp;probe[..read_len]);\nnow_offset += read_len;\nprobe = probe[read_len..].to_vec();\n}\nOk(now_offset)\n}\n</code></pre> <p>\u4f9d\u636e\u4e0a\u8ff0\u5199\u6cd5\uff0c\u5373\u53ef\u5b9e\u73b0\u5927\u6587\u4ef6\u7684\u8bfb\u5165\u3002</p>"},{"location":"6.%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3/6.1%E9%97%AE%E9%A2%98/#_2","title":"\u6587\u4ef6\u7684\u94fe\u63a5\u4e0e\u521d\u59cb\u5316","text":"<p>fat32\u6587\u4ef6\u7cfb\u7edf\u81ea\u8eab\u4e0d\u652f\u6301\u7b26\u53f7\u94fe\u63a5\uff0c\u56e0\u6b64\u9700\u8981\u5728\u5185\u6838\u4e2d\u624b\u52a8\u7ef4\u62a4\u4e00\u4e2a\u94fe\u63a5\u6620\u5c04\u3002\u4f46\u662f\u4e0d\u540c\u7684\u6587\u4ef6\u540d\u79f0\u5b57\u7b26\u4e32\u53ef\u80fd\u6307\u5411\u540c\u4e00\u4e2a\u6587\u4ef6\uff0c \u56e0\u6b64\u4e0d\u80fd\u5355\u7eaf\u5730\u5c06\u4f20\u5165\u7684\u6587\u4ef6\u540d\u4f5c\u4e3a\u6620\u5c04\u7684\u952e\u503c\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5efa\u7acb\u4e86\u4e00\u4e2a\u4ece<code>a.out</code>\u5230<code>b.out</code>\u7684\u94fe\u63a5\uff0c\u6b64\u65f6\u4f20\u5165\u7684\u6587\u4ef6\u540d\u53eb\u505a<code>./a.out</code>\uff0c\u6b64\u65f6\u5b83\u5e94\u8be5\u88ab\u8fde\u63a5\u5230<code>b.out</code>\uff0c\u4f46\u5728\u94fe\u63a5\u4e2d\u627e\u4e0d\u5230\u5bf9\u5e94\u7a0b\u5e8f\u3002</p> <p>\u4e3a\u4e86\u89c4\u8303\u5316\u8d77\u89c1\uff0cstarry\u5f15\u7528\u4e86arceos\u63d0\u4f9b\u7684<code>canonicalize</code>\u51fd\u6570\uff0c\u5c06\u6587\u4ef6\u540d\u8f6c\u5316\u4e3a\u7edf\u4e00\u683c\u5f0f\u7684\u7edd\u5bf9\u8def\u5f84\uff0c\u5e76\u4ee5\u6b64\u5efa\u7acb\u6587\u4ef6\u540d\u5230\u94fe\u63a5\u5b9e\u9645\u6587\u4ef6\u7684\u6620\u5c04\u3002</p> <p>\u56e0\u6b64\u4ece<code>a.out</code>\u5230<code>b.out</code>\u7684\u94fe\u63a5\uff0c\u4f1a\u88ab\u8f6c\u5316\u4e3a<code>./a.out</code>\u5230<code>./b.out</code>\u7684\u94fe\u63a5\uff0c\u901a\u8fc7\u89c4\u8303\u7684\u5b57\u7b26\u4e32\u4f7f\u5f97\u8bef\u5224\u7684\u60c5\u51b5\u53ef\u4ee5\u88ab\u51cf\u5c11\u3002</p> <p>\u5b9e\u73b0busybox\u3001lua\u3001lmbench\u8fc7\u7a0b\u4e2d\uff0c\u9700\u8981\u7528\u5230\u4e00\u7cfb\u5217\u7684\u94fe\u63a5\uff0c\u5bf9\u5e94\u5b9e\u73b0\u5728<code>starry_libax/test.rs</code>\u7684<code>fs_init</code>\u51fd\u6570\u4e2d\u3002\u5982\u7a0b\u5e8f\u4f1a\u5bfb\u627e<code>/lib/tls_get_new-dtv_dso.so</code>\uff0c\u800c\u5b83\u4f1a\u88ab\u5b9a\u5411\u5230<code>./tls_get_new-dtv_dso.so</code>\u6587\u4ef6\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u9700\u8981\u6211\u4eec\u624b\u52a8\u5efa\u7acb\u94fe\u63a5\u3002</p> <p>\u53e6\u5916\uff0cbusybox\u7b49\u6d4b\u4f8b\u4e5f\u9700\u8981\u6211\u4eec\u624b\u52a8\u5efa\u7acb\u4e00\u7cfb\u5217\u7684\u6587\u4ef6\u7cfb\u7edf\u4e0e\u6587\u4ef6\u5939\uff0c\u5982dev_fs\u4e0eram_fs\uff0c\u5176\u4e2ddev_fs\u5e76\u4e0d\u5141\u8bb8\u52a8\u6001\u589e\u5220\u6587\u4ef6\u5185\u5bb9\uff0c\u9700\u8981\u521d\u59cb\u5316\u65f6\u5c31\u786e\u5b9a\u597d\u3002\u76f8\u5173\u7684\u5b9e\u73b0\u5728<code>axfs/src/root.rs</code>\u7684<code>init_rootfs</code>\u51fd\u6570\uff0c\u9700\u8981\u6dfb\u52a0<code>dev/shm\u3001dev/misc</code>\u7b49\u6587\u4ef6\u5939\u3002</p>"},{"location":"6.%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3/6.1%E9%97%AE%E9%A2%98/#libc","title":"\u591a\u6838\u60c5\u51b5\u4e0blibc\u6d4b\u4f8b\u7ed3\u679c\u4e0d\u53ef\u6d4b","text":"<p>musl-libc\u6d4b\u4f8b\u4e2d\u6709\u4e00\u4e2a\u6d4b\u4f8b\u4e3apthread_cancel\uff0c\u4e3b\u8981\u662f\u6d4b\u8bd5\u7ebf\u7a0b\u662f\u5426\u53ef\u4ee5\u6b63\u5e38\u88ab\u53d6\u6d88\u3002\u4f46\u8fd9\u4e2a\u6d4b\u4f8b\u7ecf\u5e38\u4f1a\u8fd0\u884c\u5931\u8d25\uff0c\u5373\u80fd\u591f\u6210\u529f\u9000\u51fa\uff0c\u4f46\u662f\u62a5\u9519\u5e76\u672a\u53d6\u6d88\u65b0\u5efa\u7684\u7ebf\u7a0b\u3002</p> <p>\u67e5\u9605\u5bf9\u5e94\u7684\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>static void *start_single(void *arg)\n{\npthread_cleanup_push(cleanup1, arg);\nsleep(3);\npthread_cleanup_pop(0);\nreturn 0;\n}\nint main() {\n/* Cancellation cleanup handlers */\nfoo[0] = 0;\nTESTR(r, pthread_create(&amp;td, 0, start_single, foo), \"failed to create thread\");\nTESTR(r, pthread_cancel(td), \"cancelling\");\nTESTR(r, pthread_join(td, &amp;res), \"joining canceled thread\");\nTESTC(res == PTHREAD_CANCELED, \"canceled thread exit status\");\nTESTC(foo[0] == 1, \"cleanup handler failed to run\");\n}\n</code></pre> <p>\u5176\u6d4b\u8bd5\u7684\u539f\u7406\u662f\u5728<code>pthread_cleanup_push</code>\u52a0\u5165\u7ebf\u7a0b\u53d6\u6d88\u65f6\u8c03\u7528\u7684\u5904\u7406\u51fd\u6570\u3002\u82e5\u7ebf\u7a0b\u6210\u529f\u88ab\u53d6\u6d88\uff0c\u90a3\u4e48<code>cleanup1</code>\u51fd\u6570\u4f1a\u88ab\u8c03\u7528\uff0c\u6b64\u65f6\u4f1a\u4fee\u6539f00[0]\u4e3a1\uff0c\u4ee3\u8868\u6210\u529f\u53d6\u6d88\u3002</p> <p>\u4f46\u6d4b\u8bd5\u65f6\u7ecf\u5e38\u62a5\u9519\uff1a<code>cleanup handler failed to run</code>\uff0c\u901a\u8fc7\u8f93\u51faf00[0]\u53d1\u73b0\u5176\u503c\u4ecd\u7136\u4e3a0\uff0c\u5373\u7ebf\u7a0b\u53d6\u6d88\u51fd\u6570\u6ca1\u6709\u88ab\u8c03\u7528\u3002\u4f46\u662f\u8f93\u51fa\u5185\u6838\u63a5\u53d7\u5230\u7684\u7cfb\u7edf\u8c03\u7528\u4ee5\u53ca\u4fe1\u53f7\u5904\u7406\u6d41\u7a0b\u4f1a\u53d1\u73b0\u786e\u5b9e\u53d1\u51fa\u5e76\u4e14\u5904\u7406\u4e86\u53d6\u6d88\u7ebf\u7a0b\u7684\u4fe1\u53f7\u3002\u90a3\u4e48\u95ee\u9898\u51fa\u5728\u4e86\u54ea\u91cc\u5462\uff1f</p> <p>\u8f93\u51fa\u4efb\u52a1\u8c03\u5ea6\u961f\u5217\u4fe1\u606f\u53d1\u73b0\uff0c\u4e3b\u4efb\u52a1\u5728\u8c03\u7528\u4e86<code>pthread_create</code>\u4e4b\u540e\uff0c\u5e76\u6ca1\u6709\u88ab\u963b\u585e\uff0c\u53cd\u800c\u7ee7\u7eed\u8c03\u7528\u4e86<code>pthread_cancel</code>\u51fd\u6570\uff0c\u53d1\u51fa\u4e86\u53d6\u6d88\u7ebf\u7a0b\u4fe1\u53f7\uff0c\u4e4b\u540e\u518d\u88ab<code>pthread_join</code>\u51fd\u6570\u963b\u585e\u3002\u6b64\u65f6\u624d\u8c03\u5ea6\u5230\u5b50\u7ebf\u7a0b\uff0c\u5e76\u4e14\u7acb\u5373\u8fdb\u5165\u4e86\u4fe1\u53f7\u5904\u7406\u51fd\u6570\u7684\u6d41\u7a0b\uff0c\u5373\u7acb\u5373\u88ab\u53d6\u6d88\u3002\u6b64\u65f6\u5b50\u7ebf\u7a0b\u751a\u81f3\u6ca1\u6709\u8fdb\u5165\u5230<code>start_single</code>\u51fd\u6570\u5c31\u88ab\u53d6\u6d88\u4e86\u3002\u6b64\u65f6\u6ca1\u6709\u6ce8\u518c\u53d6\u6d88\u7ebf\u7a0b\u51fd\u6570\u4e3a<code>cleanup1</code>\uff0c\u56e0\u6b64\u81ea\u7136\u4e0d\u4f1a\u4fee\u6539f00[0]\u3002</p> <p>\u4f46\u662f\u95ee\u9898\u5728\u4e8e<code>pthread_create</code>\u7684\u8bed\u4e49\u8981\u6c42\u672c\u4efb\u52a1\u4f1a\u88abyield\uff0c\u5373\u5b50\u7ebf\u7a0b\u5e94\u5f53\u5728\u521b\u5efa\u4e4b\u540e\u88ab\u7acb\u5373\u6267\u884c\u3002\u7ee7\u7eeddebug\uff0c\u8f93\u51fa\u4efb\u52a1\u8c03\u5ea6\u5217\u8868\u548c\u5bf9\u5e94CPU\u7f16\u53f7\u53d1\u73b0\uff0c\u867d\u7136\u5728\u5f53\u524dCPU\u4e0a\u4e3b\u4efb\u52a1\u88abyield\u4e86\uff0c\u4f46\u5f53\u524d\u542f\u52a8\u4e86\u591a\u6838\uff0c\u95f2\u7f6e\u7684CPU\u7acb\u5373\u5c06\u521a\u88abyield\u7684\u4e3b\u4efb\u52a1\u63a5\u7ba1\u5e76\u4e14\u7ee7\u7eed\u8fd0\u884c\u3002\u5219\u6b64\u65f6\u4e3b\u4efb\u52a1\u6709\u6982\u7387\u5728\u5b50\u7ebf\u7a0b\u5f00\u59cb\u4e4b\u524d\u8c03\u7528cancel\u51fd\u6570\u53d1\u51fa\u53d6\u6d88\u4fe1\u53f7\uff0c\u4ece\u800c\u5bfc\u81f4\u7ebf\u7a0b\u53d6\u6d88\u51fd\u6570\u6ce8\u518c\u5931\u8d25\u3002</p> <p>\u5c06\u5185\u6838\u6539\u4e3a\u5355\u6838\u542f\u52a8\u4e4b\u540e\uff0c\u95ee\u9898\u6d88\u5931\u3002\u603b\u7ed3\u800c\u8a00\uff0c\u5728\u65e0\u6cd5\u6539\u52a8\u6d4b\u4f8b\u4ee3\u7801\u7684\u60c5\u51b5\u4e0b\uff0c\u8dd1musl-libc\u6d4b\u4f8b\u5e94\u5f53\u4ee5\u5355\u6838\u7684\u5f62\u5f0f\u8fdb\u884c\uff0c\u591a\u6838\u53ef\u80fd\u4f1a\u9047\u5230\u5404\u79cd\u5947\u602a\u7684\u95ee\u9898\u3002\u3002</p>"},{"location":"6.%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3/6.1%E9%97%AE%E9%A2%98/#lmbench","title":"lmbench\u6d4b\u4f8b\u7684\u7ed3\u675f","text":"<p>\u8fd0\u884clmbench\u6d4b\u4f8b\u65f6\u53d1\u73b0\u65f6\uff0c\u7a0b\u5e8f\u603b\u662f\u4f1a\u8bbf\u95ee<code>0x2,0x4,0x6,0x8</code>\u7b49\u5730\u5740\uff0c\u5bfc\u81f4<code>page fault</code>\u3002gdb\u8fdb\u884cdebug\u65e0\u679c\uff0c\u53d1\u73b0\u7a0b\u5e8f\u5df2\u7ecf\u8f93\u51fa\u4e86\u9884\u671f\u8f93\u51fa\uff0c\u4e4b\u540e\u4f1a\u76f4\u63a5\u8bbf\u95ee\u8be5\u975e\u6cd5\u5730\u5740\u3002</p> <p>\u8be2\u95ee\u5f80\u5e74\u53c2\u52a0\u6bd4\u8d5b\u7684\u5b66\u957f\uff0c\u4e86\u89e3\u5230\u53bb\u5e74\u7684lmbench\u4f1a\u5728\u6bcf\u4e2a\u6d4b\u4f8b\u7ed3\u675f\u7684\u65f6\u5019\u76f4\u63a5\u8ba9pc\u8df3\u5230\u5806\u6808\u4e0a\uff0c\u4ece\u800c\u89e6\u53d1I fault\uff0c\u901a\u8fc7\u5185\u6838\u6355\u83b7\u8be5\u4fe1\u53f7\u5e76\u8fdb\u884c\u7279\u5224\uff0c\u4ece\u800c\u624b\u52a8\u8c03\u7528exit\u7ed3\u675f\u5f53\u524d\u7684lmbench\u6d4b\u4f8b\uff0c\u8fdb\u5165\u5230\u4e0b\u4e00\u4e2almbench\u6d4b\u4f8b\u3002</p> <p>\u800c\u5728\u4eca\u5e74\u7f16\u8bd1\u5f97\u5230\u7684lmbench\u7248\u672c\uff0cpc\u4e0d\u518d\u8df3\u8f6c\u5230\u5806\u6808\uff0c\u800c\u662f\u8df3\u8f6c\u5230\u4f4e\u5730\u5740\u59820x6\uff0c\u6b64\u65f6\u4e5f\u662f\u8981\u6c42\u5185\u6838\u76f4\u63a5\u505a\u51fa\u7279\u5224\uff0c\u7ed3\u675f\u5f53\u524d\u4efb\u52a1\u3002</p> <p>\u67e5\u9605riscv\u89c4\u8303\u5f97\u77e5\uff0c\u975e\u6cd5\u8bbf\u95ee\u5185\u5b58\uff0c\u5185\u6838\u5904\u7406\u5931\u8d25\u4e4b\u540e\u5e94\u5f53\u53d1\u9001SIGSEGV\u4fe1\u53f7\u5230\u5bf9\u5e94\u7ebf\u7a0b\uff0c\u4ece\u800c\u7ed3\u675f\u5f53\u524d\u4efb\u52a1\u3002\u56e0\u6b64\u4fee\u6539\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>#[cfg(feature = \"paging\")]\nfn handle_page_fault(addr: VirtAddr, flags: MappingFlags, tf: &amp;mut TrapFrame) {\nuse axprocess::handle_page_fault;\nuse axsignal::signal_no::SignalNo;\nuse axtask::current;\naxprocess::time_stat_from_user_to_kernel();\nuse crate::syscall::signal::{syscall_sigreturn, syscall_tkill};\nif addr.as_usize() == SIGNAL_RETURN_TRAP {\n// \u8bf4\u660e\u662f\u4fe1\u53f7\u6267\u884c\u5b8c\u6bd5\uff0c\u6b64\u65f6\u5e94\u5f53\u6267\u884csig return\ntf.regs.a0 = syscall_sigreturn() as usize;\nreturn;\n}\n\nif handle_page_fault(addr, flags).is_err() {\n// \u5982\u679c\u5904\u7406\u5931\u8d25\uff0c\u5219\u53d1\u51fasigsegv\u4fe1\u53f7\nlet curr = current().id().as_u64() as isize;\naxlog::error!(\"kill task: {}\", curr);\nsyscall_tkill(curr, SignalNo::SIGSEGV as isize);\n}\naxprocess::time_stat_from_kernel_to_user();\n}\n</code></pre> <p>\u8fd9\u79cd\u60c5\u51b5\u4e0d\u4ec5\u53ef\u4ee5\u5904\u7406pc\u8df3\u8f6c\u5230\u4f4e\u5730\u5740\u7684\u60c5\u51b5\uff0c\u4e5f\u53ef\u4ee5\u5904\u7406\u8df3\u8f6c\u5230\u5806\u6808\u7684\u60c5\u51b5\uff0c\u66f4\u52a0\u5730\u89c4\u8303\u5316\u3002</p>"}]}